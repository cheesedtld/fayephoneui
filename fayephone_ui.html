<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>èŠå¤©ç•Œé¢ (é€‚é…å™¨å¢å¼ºç‰ˆ)</title>
<!-- å¼•å…¥ Google Fonts æ‰‹å†™å­—ä½“ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<style>
/* CSSå˜é‡å®šä¹‰ */
:root {
--interface-bg: rgba(247, 247, 247, 0.6);
--msg-name-color: #999999;
--msg-time-color: #b0b0b0;
}

/* èŠå¤©æ°”æ³¡æ ·å¼ */
.bubble {
    display: inline-block;
    padding: 10px 15px;
    border-radius: 20px;
    margin: 5px 0;
    max-width: 210px;
    min-width: 48px;
    width: fit-content;
    word-break: break-all;
    font-size: 16px;
    line-height: 1.5;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* æ‰‹æœºå®¹å™¨ */
#phone-container {
width: 330px;
height: 660px;
max-width: 95vw;
max-height: 95vh;
border: 8px solid #707070; 
border-radius: 50px;
background: #707070;
background-size: cover;
background-position: center;
box-shadow:
inset 0 0 0 2px rgba(0,0,0,0.1),
0 20px 50px rgba(0, 0, 0, 0.3);
display: flex;
flex-direction: column;
overflow: hidden;
position: relative;
transition: width 0.3s, height 0.3s, border-color 0.3s;
box-sizing: content-box;
}

/* Home Indicator */
#home-indicator {
position: absolute;
bottom: 5px;
left: 50%;
transform: translateX(-50%);
width: 130px;
height: 4px;
background-color: #000;
border-radius: 10px;
z-index: 200;
pointer-events: none;
}

/* --- çµåŠ¨å²› --- */
.status-bar {
position: absolute; top: 0; left: 0; width: 100%; height: 50px;
display: flex; justify-content: space-between; align-items: flex-start;
padding-top: 14px; padding-left: 26px; padding-right: 26px; box-sizing: border-box;
z-index: 100; font-size: 14px; font-weight: 600; pointer-events: none; transition: color 0.3s;
}
.status-bar.text-dark { color: #000; } .status-bar.text-dark svg { fill: #000; }
.status-bar.text-light { color: #fff; } .status-bar.text-light svg { fill: #fff; }
.sb-left { width: 60px; text-align: center; }
.sb-right { width: 60px; display: flex; justify-content: center; align-items: center; gap: 6px; }
.dynamic-island {
width: 96px; height: 28px; background-color: #000; border-radius: 14px;
position: absolute; left: 50%; top: 10px; transform: translateX(-50%); z-index: 101;
display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; pointer-events: auto;
}
.island-camera {
width: 10px; height: 10px; background: #1a1a1a; border-radius: 50%;
box-shadow: inset 0 0 3px rgba(255,255,255,0.2);
}

/* --- å±å¹•ç®¡ç† --- */
.screen {
flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%;
position: absolute; top: 0; left: 0; background-size: cover; background-position: center;
transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.4s, filter 0.4s;
overflow: hidden;
background-color: #fff;
/* ä¿®å¤çª„å±ä¸‹é¡µé¢å·¦å³æ™ƒåŠ¨çš„é—®é¢˜ */
overflow-x: hidden;
box-sizing: border-box;
}
#home-screen {
z-index: 1; padding-top: 0;
align-items: center;
/* ä¿®å¤çª„å±ä¸‹é¡µé¢å·¦å³æ™ƒåŠ¨çš„é—®é¢˜ */
overflow-x: hidden;
width: 100%;
justify-content: center;
background-color: #f3e5f5;
transform: translateX(0); opacity: 1;
}
#home-screen.slide-out {
transform: translateX(-30%);
opacity: 0.8;
filter: brightness(0.8);
pointer-events: none;
}

/* ä¸»å±å¹•æ—¶é—´ */
#home-clock {
font-family: 'Dancing Script', 'Ma Shan Zheng', cursive, sans-serif;
font-size: 60px;
letter-spacing: 4px;
color: #4a3b5e;
margin-bottom: 80px;
font-weight: normal;
text-shadow: 0 2px 5px rgba(0,0,0,0.1);
z-index: 5;
}

/* å­é¡µé¢ */
#message-list-screen {
z-index: 8;
transform: translateX(100%);
box-shadow: -5px 0 15px rgba(0,0,0,0.05);
background-color: #fff;
}
#message-list-screen.visible {
transform: translateX(0);
}

/* Right side sliders */
#chat-screen, #dark-search-screen {
z-index: 10;
transform: translateX(100%);
box-shadow: -5px 0 15px rgba(0,0,0,0.05);
}

/* Left side sliders */
#settings-screen, #diary-screen {
z-index: 10;
transform: translateX(-100%);
box-shadow: 5px 0 15px rgba(0,0,0,0.05);
}

/* Visible state for all horizontal sliders */
#chat-screen.visible, #dark-search-screen.visible, #settings-screen.visible, #diary-screen.visible {
transform: translateX(0);
}

/* Message List Styles */
.message-list-body {
flex: 1;
background: #fff;
overflow-y: auto;
}
.message-list-item {
display: flex;
padding: 12px 15px;
border-bottom: 1px solid #f0f0f0;
cursor: pointer;
align-items: center;
transition: background-color 0.2s;
}
.message-list-item:active {
background-color: #f5f5f5;
}
.message-list-avatar {
width: 48px;
height: 48px;
border-radius: 6px;
margin-right: 12px;
object-fit: cover;
background-color: #eee;
}
.message-list-info {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
overflow: hidden;
}
.message-list-top {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 4px;
}
.message-list-name {
font-size: 16px;
font-weight: 500;
color: #333;
}
.message-list-time {
font-size: 12px;
color: #999;
}
.message-list-preview {
font-size: 14px;
color: #999;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.app-grid {
display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px; padding: 0 24px; width: 100%; box-sizing: border-box;
margin-bottom: 50px;
}
.app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; position: relative; }
.app-item:active { opacity: 0.7; transform: scale(0.95); transition: 0.1s; }
.app-icon-box {
width: 58px; height: 58px; border-radius: 16px; display: flex; align-items: center; justify-content: center;
background: #e6e6fa;
transition: background 0.3s;
box-shadow: none;
opacity: 0.72;
}
.app-icon-box svg { width: 32px; height: 32px; transition: fill 0.3s; fill: #483d8b; }
.app-icon-image {
width: 32px; height: 32px;
background-color: #483d8b;
-webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;
mask-size: contain; mask-repeat: no-repeat; mask-position: center;
transition: background-color 0.3s;
}
.app-name { font-size: 12px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.3); color: #4a3b5e; }

/* Header */
.app-header {
height: 80px; padding-top: 40px;
display: flex; align-items: center;
padding-left: 15px; padding-right: 15px;
background-color: var(--interface-bg);
backdrop-filter: blur(10px);
border-bottom: 1px solid rgba(0,0,0,0.05);
flex-shrink: 0; z-index: 10; box-sizing: border-box;
transition: background-color 0.3s;
}
.header-content { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; position: absolute; left: 0; }
.header-btn svg { width: 24px; height: 24px; fill: #181818; }
.header-title { font-size: 17px; font-weight: 600; color: #181818; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; max-width: 70%; }

/* Chat Area */
#chat-messages {
flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
scroll-behavior: smooth; scrollbar-width: none;
}
#chat-messages::-webkit-scrollbar { display: none; }

.settings-body {
flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
background: #f2f2f7;
}
.settings-body::-webkit-scrollbar { display: none; }

/* Blocked Status Icon */
.msg-status-blocked {
    color: #ff3b30;
    font-size: 17px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: help;
    flex-shrink: 0;
    line-height: 1.2;
}

/* Message Meta Container (Time + Status) */
.msg-meta {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    gap: 1px;
    margin-bottom: 0px;
}
/* Adjust margins for meta container based on sender */
.message-row.sent .msg-meta { margin-right: 2px; }
.message-row.received .msg-meta { margin-left: 2px; }

/* Toggle Switch */
.switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #2196F3; }
input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
input:checked + .slider:before { transform: translateX(20px); }

/* Message Styles */
/* Love Effect */
.love-effect-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 999;
}
.love-heart {
    position: absolute; bottom: -20px; font-size: 24px; animation: floatUp 4s ease-in-out forwards; opacity: 0;
}
@keyframes floatUp {
    0% { transform: translateY(0) scale(0.5); opacity: 0; }
    10% { opacity: 1; }
    100% { transform: translateY(-600px) scale(1.5); opacity: 0; }
}

/* æ¶ˆæ¯è¡Œå®¹å™¨ï¼šåŒ…å«å¤´åƒã€æ¶ˆæ¯å†…å®¹ã€æ—¶é—´ç­‰ */
.message-row { display: flex; align-items: flex-start; gap: 8px; width: 100%; flex-shrink: 0; }
/* å‘é€æ–¹ï¼ˆå³ä¾§ï¼‰æ ·å¼ */
.message-row.sent { flex-direction: row-reverse; }
/* æ¥æ”¶æ–¹ï¼ˆå·¦ä¾§ï¼‰æ ·å¼ */
.message-row.received { flex-direction: row; }
/* å¤´åƒæ ·å¼ */
.avatar { width: 38px; height: 38px; border-radius: 6px; background-color: #e0e0e0; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05); margin-top: 0; }

/* æ¶ˆæ¯å†…å®¹å®¹å™¨ï¼šåŒ…å«åå­—ã€æ°”æ³¡ã€å¿ƒå£°ç­‰ */
.msg-container { display: flex; flex-direction: column; max-width: 70%; }
.message-row.sent .msg-container { align-items: flex-end; }
.message-row.received .msg-container { align-items: flex-start; }

/* åå­—æ ·å¼ */
.msg-name {
font-size: 12px; color: var(--msg-name-color);
margin: 0 2px 2px 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* æ°”æ³¡å’Œæ—¶é—´çš„åŒ…è£…å™¨ */
.msg-wrapper {
display: flex; flex-direction: row; align-items: flex-end; gap: 3px; margin-top: 2px;
}
.message-row.sent .msg-wrapper { flex-direction: row-reverse; }
.message-row.received .msg-wrapper { flex-direction: row; }

/* å¿ƒå£°æ°”æ³¡æ ·å¼ */
.msg-thought {
font-size: 12px; color: #333; background-color: rgba(200, 200, 200, 0.5);
border-radius: 14px; padding: 4px 8px; margin-top: 1px;
line-height: 1.3; word-wrap: break-word; max-width: 100%; box-sizing: border-box;
text-align: left;
}

/* æ‰€æœ‰æ°”æ³¡ç±»å‹çš„é€šç”¨æ ·å¼ */
.bubble, .location-card, .transfer-card, .file-card, .voice-card, .photo-card, .sticker-bubble, .real-audio-card {
flex-shrink: 0; cursor: pointer; position: relative; transition: transform 0.1s; max-width: 210px;
}
/* æŒ‰å‹æ•ˆæœ */
.bubble.pressing, .location-card.pressing, .transfer-card.pressing, .file-card.pressing, .voice-card.pressing, .photo-card.pressing, .sticker-bubble.pressing, .real-audio-card.pressing {
transform: scale(0.98); filter: brightness(0.95);
}

/* æ™®é€šæ–‡æœ¬æ°”æ³¡æ ·å¼ */
.bubble {
padding: 7px 14px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; font-size: var(--msg-font-size, 14px);
opacity: 0.8;
}
/* å‘é€æ–¹æ–‡æœ¬æ°”æ³¡ */
.bubble-sent {
background: #dcd0ff; color: #000; border-top-right-radius: 0px;
}
/* æ¥æ”¶æ–¹æ–‡æœ¬æ°”æ³¡ */
.bubble-received {
background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px;
}

/* æ¶ˆæ¯æ—¶é—´æ ·å¼ */
.msg-time {
font-size: 10px; color: var(--msg-time-color); line-height: 1; user-select: none; padding: 0 2px; margin-bottom: 0px; flex-shrink: 0; min-width: 28px;
}
.message-row.sent .msg-time { text-align: right; }
.message-row.received .msg-time { text-align: left; }

/* å›¾ç‰‡/è§†é¢‘å¡ç‰‡æ ·å¼ */
.photo-card { border-radius: 18px; padding: 6px; overflow: visible; box-shadow: 0 2px 3px rgba(0,0,0,0.1); font-size: 0; max-width: 160px; width: 100%; box-sizing: border-box; }
.photo-card.sent { border-top-right-radius: 0px; }
.photo-card.received { border-top-left-radius: 0px; }
.photo-card img { width: 100%; height: auto; display: block; border-radius: 12px; }

/* è¡¨æƒ…åŒ…æ°”æ³¡æ ·å¼ */
.sticker-bubble { border-radius: 14px; overflow: visible; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0; max-width: 100px; }
.sticker-bubble img { width: 100%; height: auto; display: block; border-radius: 14px; }

/* æ¨¡æ‹Ÿè¯­éŸ³å¡ç‰‡æ ·å¼ */
.voice-card {
    padding: 7px 10px;
    border-radius: 18px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 48px;
    width: fit-content;
    position: relative;
    max-width: 210px;
}
.voice-card.sent { background: #dcd0ff; color: #000; border-top-right-radius: 0px; }
.voice-card.received { background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px; }
.voice-bar { display: flex; align-items: center; gap: 4px; height: 20px; }
.voice-card.sent .voice-bar { flex-direction: row-reverse; }
.voice-duration { font-size: 14px; font-weight: 500; min-width: 25px; text-align: center; }
.voice-waves { display: flex; align-items: center; gap: 1.5px; height: 100%; flex: 1; justify-content: center; overflow: hidden; }
.wave { width: 2px; background-color: currentColor; border-radius: 2px; opacity: 0.7; }
.voice-text {
font-size: 13px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); display: none; white-space: pre-wrap; line-height: 1.4; text-align: left; word-break: break-all;
}
.voice-card.show-text .voice-text { display: block; }
.voice-card.sent .voice-text { text-align: right; }
.voice-card.sent .voice-text.multiline { text-align: left; }

/* çœŸå®éŸ³é¢‘å¡ç‰‡æ ·å¼ */
.real-audio-card {
padding: 5px; border-radius: 18px; display: flex; align-items: center; justify-content: center;
background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; max-width: 220px;
}
.real-audio-card audio {
max-width: 100%; height: 32px;
}
.real-audio-card.sent { border-top-right-radius: 0px; background: #dcd0ff; }
.real-audio-card.received { border-top-left-radius: 0px; background: #ffffff; }

/* ä½ç½®ã€è½¬è´¦ã€æ–‡ä»¶å¡ç‰‡é€šç”¨æ ·å¼ */
.location-card, .transfer-card, .file-card { width: 200px; overflow: visible; }
/* ä½ç½®å¡ç‰‡ */
.location-card { background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
.location-info { padding: 8px 10px; background: #fff; border-top-left-radius: 6px; border-top-right-radius: 6px; }
.location-name { font-size: 13px; color: #333; font-weight: 500; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.location-map { width: 100%; height: 60px; background-color: #f2f2f2; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="90" viewBox="0 0 220 90"><rect width="220" height="90" fill="%23f2f2f2"/><path d="M-10,30 Q50,10 110,30 T230,30" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M30,90 Q60,50 90,90" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M150,0 Q180,40 210,0" stroke="%23ddd" stroke-width="6" fill="none"/><circle cx="110" cy="45" r="4" fill="%23ea4e3d"/></svg>'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
.location-pin { width: 20px; height: 20px; fill: #ea4e3d; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); margin-bottom: 8px; }

/* è½¬è´¦å¡ç‰‡ */
.transfer-card { background: #ffacac; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.transfer-top { padding: 12px; display: flex; align-items: center; gap: 10px; border-top-left-radius: 6px; border-top-right-radius: 6px; }
.transfer-icon-circle { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.transfer-icon-circle svg { width: 20px; height: 20px; stroke: #fff; stroke-width: 2; fill: none; }
.transfer-content { flex: 1; color: #fff; display: flex; flex-direction: column; overflow: hidden; }
.transfer-amount { font-size: 15px; font-weight: bold; }
.transfer-note { font-size: 11px; opacity: 0.9; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.transfer-bottom { background: #fff; padding: 4px 12px; font-size: 10px; color: #999; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }

/* æ–‡ä»¶å¡ç‰‡ */
.file-card { background: white; border-radius: 6px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; border: 1px solid #eee; }
.file-info { flex: 1; overflow: hidden; }
.file-name { font-size: 13px; color: #333; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; word-break: break-all; }
.file-size { font-size: 9px; color: #999; margin-top: 3px; }
.file-icon { width: 34px; height: 34px; flex-shrink: 0; }
.file-icon svg { width: 100%; height: 100%; fill: #ddd; }

/* Media Preview Bar */
#media-preview-bar {
display: none; padding: 8px 12px;
background: var(--interface-bg);
backdrop-filter: blur(10px);
border-top: 1px solid rgba(0,0,0,0.05);
flex-shrink: 0; z-index: 10;
align-items: center;
}
#media-preview-bar.visible { display: flex; }
.preview-item {
position: relative; width: 60px; height: 60px;
background: #fff; border-radius: 8px; border: 1px solid #ddd;
display: flex; align-items: center; justify-content: center;
overflow: visible;
}
.preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
.preview-file-icon { font-size: 24px; }
.preview-close {
position: absolute; top: -6px; right: -6px;
width: 18px; height: 18px; background: #ff5555; color: white;
border-radius: 50%; font-size: 12px; line-height: 16px; text-align: center;
cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
font-weight: bold;
}

/* Input Bar */
#input-bar {
display: flex; padding: 5px 5px;
border-top: none; /* No white line */
background-color: var(--interface-bg);
backdrop-filter: blur(10px);
align-items: flex-end; flex-shrink: 0; z-index: 10;
padding-bottom: 15px;
transition: background-color 0.3s;
}
#input-bar textarea {
flex: 1; border: none; border-radius: 20px; padding: 6px 10px;
font-size: 15px; resize: none; max-height: 80px; outline: none; min-height: 20px;
background: rgba(245, 245, 245, 0.9); color: #000; /* Ensure text is black */
margin-right: 4px;
scrollbar-width: none; /* Firefox */
}
#input-bar textarea::-webkit-scrollbar { display: none; } /* Chrome/Safari */

.toolbar-btn {
background: transparent; color: var(--chat-btn-text, #333); border: none;
width: 30px; height: 30px;
display: flex; align-items: center; justify-content: center; flex-shrink: 0;
cursor: pointer; transition: background 0.2s;
margin-bottom: 2px; border-radius: 6px;
}
.toolbar-btn:hover { opacity: 0.9; }
.toolbar-btn svg { width: 22px; height: 22px; stroke: var(--chat-btn-text, #580000); stroke-width: 1.5; fill: none; transition: stroke 0.2s; }
.toolbar-btn.active svg { transform: rotate(45deg); }

#plus-button { margin-right: 0px; padding: 0; }
#emoji-button { margin-left: 0px; margin-right: 4px; }

#send-button {
background: transparent; color: var(--chat-btn-text, #ffffff); border-radius: 6px;
height: 32px; padding: 0 12px; font-size: 15px; font-weight: 600;
margin-left: 0px; margin-bottom: 3px; width: auto;
display: flex; align-items: center; justify-content: center;
border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
}
#send-button:hover { opacity: 0.9; }

/* Menus */
#action-menu, #emoji-menu {
height: 0; background: #f7f7f7; border-top: none; transition: height 0.2s ease; overflow: hidden;
flex-shrink: 0; z-index: 10;
}
#action-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 0 20px; }
#action-menu.open { height: 220px; padding: 25px 20px; border-top: 1px solid #e5e5e5; }
#emoji-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 0 12px; overflow-y: auto; box-sizing: border-box; align-content: flex-start; justify-items: center; }
#emoji-menu.open { height: 220px; padding: 15px 12px; border-top: 1px solid #e5e5e5; }
#emoji-menu::-webkit-scrollbar { display: none; }

.action-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: #666; font-size: 12px; }
.action-icon-box { width: 55px; height: 55px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e5e5; }

.sticker-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; }
.sticker-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #fff; }
.sticker-add-btn { width: 60px; height: 60px; border-radius: 8px; background: #f7f7f7; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; box-sizing: border-box; }
.sticker-add-btn svg { width: 28px; height: 28px; fill: #999; }
.sticker-name { font-size: 10px; color: #666; margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

/* Modals */
.modal-overlay {
position: absolute; top: 0; left: 0; right: 0; bottom: 0;
background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center;
z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
#input-modal { z-index: 210; } /* Ensure input modal is on top */
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal-box {
box-sizing: border-box;
width: 85%; max-width: 300px; background: #fff; border-radius: 12px; padding: 20px;
box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
transform: scale(0.9); transition: transform 0.2s; max-height: 70%; overflow-y: auto; scrollbar-width: none;
}
.modal-overlay.show .modal-box { transform: scale(1); }
.modal-title { font-size: 18px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
.modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; border: none; font-weight: 500; }
.btn-cancel { background: #f0f0f0; color: #333; }
.btn-confirm { background: #07c160; color: white; }
.btn-grey { background: #e5e5e5; color: #333; } .btn-grey:active { background: #d1d1d1; }

#modal-inputs-container { display: flex; flex-direction: column; gap: 12px; }
.modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; outline: none; }
.modal-input:focus { border-color: #07c160; }

/* Settings UI */
.settings-body {
flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
background: #fdf6f9; /* å¯çˆ±ç²‰è‰²èƒŒæ™¯ */
}
.settings-body::-webkit-scrollbar { display: none; }

.settings-section-title {
display: block;
font-size: 13px;
color: #999;
margin-left: 12px;
margin-bottom: 8px;
font-weight: 600;
letter-spacing: 0.5px;
}

.setting-group {
background: #fff;
border-radius: 18px;
padding: 0;
display: flex;
flex-direction: column;
border: 1px solid rgba(0,0,0,0.02);
overflow: hidden;
box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.setting-group.no-border { border: none; }

.setting-row {
display: grid; grid-template-columns: 1fr auto; align-items: center; font-size: 15px; color: #333; gap: 10px;
padding: 16px 18px; border-bottom: 1px solid #f7f7f7;
}
.settings-footer {
padding: 20px; background: transparent; border-top: none;
flex-shrink: 0; z-index: 10;
}
.btn-save {
background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
color: #fff;
border: none;
font-weight: 600;
box-shadow: 0 4px 12px rgba(255, 154, 158, 0.4);
transition: transform 0.1s, box-shadow 0.1s;
}
.btn-save:active {
transform: scale(0.98);
box-shadow: 0 2px 6px rgba(255, 154, 158, 0.3);
}

.setting-row:last-child { border-bottom: none; }
.setting-row > div { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }
.color-picker { width: 28px; height: 28px; border: 1px solid #ddd; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; }
.color-picker::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker::-webkit-color-swatch { border: none; border-radius: 50%; }
.setting-input-sm { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
.file-upload-label {
font-size: 12px; background: #f2f2f7; border: 1px solid #ddd; padding: 5px 10px;
border-radius: 14px; cursor: pointer; display: inline-flex; align-items: center;
transition: background 0.2s; appearance: none; color: #333; font-family: inherit;
}
.file-upload-label:active { background: #e5e5ea; }
.file-upload-input { display: none; }
.preview-img { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #ddd; }

.delete-btn {
position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
background-color: #c0c0c0; color: #fff; border-radius: 50%;
display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
}
.delete-btn svg { width: 10px; height: 10px; stroke: currentColor; stroke-width: 3; }
.typing-dots span {
display: inline-block; width: 6px; height: 6px; background-color: #888;
border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite ease-in-out both;
}
.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
.dark-result-item {
    border-bottom: 1px solid #333;
    padding: 10px 0;
    color: #ff69b4;
    font-family: monospace;
    animation: fadeIn 0.5s ease;
}
.dark-result-content {
    font-size: 14px;
    margin-bottom: 4px;
    word-break: break-all;
}
.dark-result-time {
    font-size: 10px;
    color: #880044;
    text-align: right;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
// è‡ªåŠ¨å‘çˆ¶çª—å£å‘é€phone-containerå®½é«˜ï¼Œä¾›åŠ è½½å™¨è‡ªé€‚åº”iframe
function postPhoneContainerSize() {
    try {
        var phone = document.getElementById('phone-container');
        if (phone && window.parent !== window) {
            var rect = phone.getBoundingClientRect();
            window.parent.postMessage({
                type: 'fayephone-resize',
                width: Math.round(rect.width),
                height: Math.round(rect.height)
            }, '*');
        }
    } catch(e) {}
}
window.addEventListener('DOMContentLoaded', postPhoneContainerSize);
window.addEventListener('resize', postPhoneContainerSize);
// å…¼å®¹è®¾ç½®å˜æ›´å
setInterval(postPhoneContainerSize, 1000);
// ä¿å­˜è®¾ç½®åä¹ŸåŒæ­¥å®½é«˜
window.saveHomeSettings = (function(orig){
    return async function() {
        if (orig) await orig.apply(this, arguments);
        setTimeout(postPhoneContainerSize, 100);
    }
})(window.saveHomeSettings);
// ç”¨æˆ·äº¤äº’åä¹ŸåŒæ­¥
document.addEventListener('click', function(){ setTimeout(postPhoneContainerSize, 200); });
</script>
</head>
<body>
<div id="phone-container">
<div id="home-indicator"></div>
<div class="status-bar text-dark" id="status-bar">
<div class="sb-left" id="clock">12:00</div>
<div class="dynamic-island"><div class="island-camera"></div></div>
<div class="sb-right">
<svg width="22" height="11" viewBox="0 0 22 11" fill="currentColor">
<path d="M4 5 l1.5 2.5 h-3 z" />
<path d="M4 11 l-1.5 -2.5 h3 z" />
<path d="M7 5.5h2v6H7v-6zm4-3h2v9H11v-9zm4-3h2v12h-2V-.5z"></path>
</svg>
<svg width="22" height="11" viewBox="0 0 25 11" fill="currentColor"><rect x="0.5" y="0.5" width="20" height="10" rx="2.5" stroke="currentColor"></rect><path d="M23 4v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path><rect x="2.5" y="2.5" width="16" height="6" rx="1" fill="currentColor"></rect></svg>
</div>
</div>
<div id="home-screen" class="screen">
<div id="home-clock">12:00</div>
<div class="app-grid">
<div class="app-item" onclick="openMessageList()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/basil:wechat-solid.svg'); mask-image: url('https://api.iconify.design/basil:wechat-solid.svg');"></div></div>
<span class="app-name">èŠå¤©</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/simple-icons:qzone.svg'); mask-image: url('https://api.iconify.design/simple-icons:qzone.svg');"></div></div>
<span class="app-name">æœ‹å‹åœˆ</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg'); mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg');"></div></div>
<span class="app-name">è®ºå›</span>
</div>
<div class="app-item" onclick="openDarkSearch()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/mingcute:search-3-line.svg'); mask-image: url('https://api.iconify.design/mingcute:search-3-line.svg');"></div></div>
<span class="app-name">æš—ç½‘æœç´¢</span>
</div>
<div class="app-item" onclick="openDiary()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/ri:booklet-line.svg'); mask-image: url('https://api.iconify.design/ri:booklet-line.svg');"></div></div>
<span class="app-name">æ—¥è®°</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/fa-brands:discord.svg'); mask-image: url('https://api.iconify.design/fa-brands:discord.svg');"></div></div>
<span class="app-name">Discord</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'><text x=\'50%25\' y=\'50%25\' dy=\'.35em\' font-family=\'Arial\' font-weight=\'900\' font-size=\'14\' text-anchor=\'middle\'>ST</text></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'><text x=\'50%25\' y=\'50%25\' dy=\'.35em\' font-family=\'Arial\' font-weight=\'900\' font-size=\'14\' text-anchor=\'middle\'>ST</text></svg>');"></div></div>
<span class="app-name">SillyTavern</span>
</div>
<div class="app-item" onclick="openSettings()">
<div class="app-icon-box app-icon-style"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg></div>
<span class="app-name">è®¾ç½®</span>
</div>
</div>
</div>
<div id="message-list-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title">æ¶ˆæ¯</span>
</div>
</div>
<div class="message-list-body" id="message-list-body">
<!-- åˆ—è¡¨é¡¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
</div>
</div>
<div id="chat-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" id="header-title">{{char}}</span>
</div>
</div>
<div id="chat-messages"></div>
<div id="love-effect-layer" class="love-effect-container"></div>

<!-- åª’ä½“é¢„è§ˆæ¡ -->
<div id="media-preview-bar">
    <div class="preview-item">
        <img id="preview-image" src="" style="display:none">
        <div id="preview-file-icon" class="preview-file-icon" style="display:none">ğŸµ</div>
        <div class="preview-close" onclick="clearPreview()">Ã—</div>
    </div>
</div>

<div id="input-bar">
<button id="plus-button" class="toolbar-btn" title="æ›´å¤šåŠŸèƒ½"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
<button id="emoji-button" class="toolbar-btn"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9" stroke-width="2" stroke-linecap="round"></line><line x1="15" y1="9" x2="15.01" y2="9" stroke-width="2" stroke-linecap="round"></line></svg></button>
<textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
<button id="send-button">å‘é€</button>
</div>
<input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
<input type="file" id="audio-upload-input" accept="audio/*" style="display: none;">
<input type="file" id="video-upload-input" accept="video/*" style="display: none;">
<input type="file" id="settings-file-input" accept="image/*" style="display: none;">
<div id="action-menu">
<div class="action-item" onclick="handleAction('photo')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div><span>ç…§ç‰‡</span></div>
<div class="action-item" onclick="handleAction('voice')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div><span>è¯­éŸ³</span></div>
<div class="action-item disabled" onclick="handleAction('call')"><div class="action-icon-box" style="opacity: 0.5;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div><span>é€šè¯</span></div>
<div class="action-item" onclick="handleAction('camera')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></div><span>ç›¸æœº</span></div>
<div class="action-item" onclick="handleAction('location')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><span>ä½ç½®</span></div>
<div class="action-item" onclick="handleAction('transfer')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><span>è½¬è´¦</span></div>
<div class="action-item" onclick="handleAction('file')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div><span>æ–‡ä»¶</span></div>
<div class="action-item" onclick="openChatSettings()"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div><span>è®¾ç½®</span></div>
</div>
<div id="emoji-menu"></div>
</div>
<div id="settings-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="closeSettings()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title">æ‰‹æœºè®¾ç½®</span>
</div>
</div>
<div class="settings-body">
    <!-- å¤–è§‚ -->
    <div>
        <div class="settings-section-title">å¤–è§‚</div>
        <div class="setting-group">
            <div class="setting-row"><label>æ‰‹æœº (å®½xé«˜)</label> <div><input type="number" id="set-phone-w" class="setting-input-sm" placeholder="350"> x <input type="number" id="set-phone-h" class="setting-input-sm" placeholder="650"></div></div>
            <div class="setting-row"><label>æ‰‹æœºå£³é¢œè‰²</label> <input type="color" id="set-case-color" class="color-picker"></div>
        </div>
    </div>

    <!-- ä¸ªæ€§åŒ– -->
    <div>
        <div class="settings-section-title">ä¸ªæ€§åŒ–</div>
        <div class="setting-group">
            <div class="setting-row"><label>ä¸»å±å¹•å£çº¸</label> <div><button class="file-upload-label" onclick="triggerSettingsUpload('home-bg')">ä¸Šä¼ å›¾ç‰‡</button> <img id="preview-home-bg" class="preview-img" src=""></div></div>
            <div class="setting-row"><label>è‡ªå®šä¹‰æ—¶é—´</label> <input type="text" id="set-custom-time" class="setting-input-sm" style="width: 80px;" placeholder="HH:MM"></div>
        </div>
    </div>

    <!-- å›¾æ ‡ä¸æ–‡å­— -->
    <div>
        <div class="settings-section-title">å›¾æ ‡ä¸æ–‡å­—</div>
        <div class="setting-group">
            <div class="setting-row"><label>å›¾æ ‡åº•è‰²</label> <input type="color" id="set-icon-bg" class="color-picker"></div>
            <div class="setting-row"><label>å›¾æ ‡å›¾æ¡ˆ</label> <input type="color" id="set-icon-color" class="color-picker"></div>
            <div class="setting-row"><label>å­—ä½“é¢œè‰²</label> <input type="color" id="set-home-text-color" class="color-picker"></div>
        </div>
    </div>

    <!-- ç³»ç»Ÿ -->
    <div>
        <div class="settings-section-title">ç³»ç»Ÿ</div>
        <div class="setting-group">
            <div class="setting-row"><label>é€‚é…å™¨æ’ä»¶</label> <div id="adapter-status" style="font-size:12px;color:#999;">æ£€æµ‹ä¸­...</div></div>
        </div>
    </div>
</div>
<div class="settings-footer">
<button class="modal-btn btn-save" style="width: 100%; padding: 14px; border-radius: 20px;" onclick="saveHomeSettings()">ä¿å­˜å¹¶åº”ç”¨</button>
</div>
</div>
<div id="dark-search-screen" class="screen" style="background-color: #000; color: #ff69b4;">
<div class="app-header" style="background-color: #111; border-bottom: 1px solid #333;">
<div class="header-content">
<div class="header-btn" onclick="closeDarkSearch()"><svg viewBox="0 0 24 24" style="fill: #ff69b4;"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" style="color: #ff69b4;">æš—ç½‘æœç´¢</span>
</div>
</div>
<div style="padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; height: 100%; box-sizing: border-box;">
<div style="width: 100%; position: relative; flex-shrink: 0;">
<input type="text" id="dark-search-input" placeholder="è¾“å…¥åå­—æŸ¥çœ‹è®°å½•..." style="width: 100%; padding: 12px 40px 12px 15px; background: #111; border: 1px solid #333; color: #ff69b4; border-radius: 8px; box-sizing: border-box; outline: none;">
<div onclick="searchDarkWeb()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
</div>
</div>
<div id="dark-search-results" style="width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
    <div style="font-size: 12px; color: #333; text-align: center; margin-top: 50px;">TOR NETWORK CONNECTED</div>
</div>
</div>
</div>
<div id="diary-screen" class="screen" style="background-color: #fdfbfb; color: #5d4037;">
<div class="app-header" style="background-color: #fdfbfb; border-bottom: 1px solid rgba(0,0,0,0.03);">
<div class="header-content">
<div class="header-btn" onclick="closeDiary()"><svg viewBox="0 0 24 24" style="fill: #8d6e63;"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" style="color: #8d6e63; font-family: 'Ma Shan Zheng', cursive;">ç§å¯†æ—¥è®°</span>
</div>
</div>
<div id="diary-scroll-container" style="padding: 20px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; overflow-y: auto; scrollbar-width: none;">
<style>
#diary-scroll-container::-webkit-scrollbar { display: none; }
.diary-card {
    background: #fff;
    padding: 15px 20px;
    border-radius: 8px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
}
.diary-card:active { transform: scale(0.99); }
.diary-header {
    display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; color: #999;
    padding-bottom: 5px;
    border-bottom: 2px solid #f5f5f5;
}
.diary-date { font-weight: bold; color: #d4a5a5; font-family: 'Ma Shan Zheng', cursive; font-size: 15px; }
.diary-weather { background: #f5f5f5; color: #888; padding: 1px 6px; border-radius: 4px; font-size: 10px; height: fit-content; }
.diary-body { 
    font-size: 15px; 
    line-height: 28px; 
    color: #666; 
    background-image: url("data:image/svg+xml;utf8,<svg width='12' height='28' xmlns='http://www.w3.org/2000/svg'><rect x='0' y='27' width='6' height='1' fill='%23e0e0e0'/></svg>");
    background-attachment: local;
    word-break: break-all;
    text-align: justify;
}
.diary-body p { margin: 0; }
</style>
<div id="diary-lock-container" style="flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px;">
<div style="color: #d4a5a5; font-size: 14px; font-family: 'Ma Shan Zheng', cursive;">æŸ¥çœ‹ <input type="text" id="diary-target-name" placeholder="åå­—" style="border:none; border-bottom:1px solid #d4a5a5; width:60px; text-align:center; color:#8d6e63; font-family:inherit; background:transparent; outline:none;"> çš„æ—¥è®°</div>
<div onclick="generateDiary()" style="cursor: pointer; padding: 25px; border-radius: 50%; background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: transform 0.3s; border: 1px solid #f0f0f0;">
<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#d4a5a5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
</svg>
</div>
<div style="color: #d4a5a5; font-size: 14px; font-family: 'Ma Shan Zheng', cursive;">ç‚¹å‡»å·çœ‹æ—¥è®°...</div>
</div>
<div id="diary-content" style="display: none; flex-direction: column; gap: 15px; padding-bottom: 20px;">
<!-- Entries will be injected here -->
</div>
</div>
</div>
<div id="input-modal" class="modal-overlay">
<div class="modal-box">
<div class="modal-title" id="modal-title">è¾“å…¥å†…å®¹</div>
<div id="modal-inputs-container"></div>
<div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="modal-btn btn-grey" id="modal-confirm-btn">å‘é€</button></div>
</div>
</div>
<div id="chat-settings-modal" class="modal-overlay">
<div class="modal-box" style="padding: 0; overflow: hidden; display: flex; flex-direction: column; background: #fdf6f9;">
<div class="modal-title" style="padding: 10px 20px; margin: 0; background: #fff; flex-shrink: 0; border-bottom: 1px solid #f0f0f0;">èŠå¤©è®¾ç½®</div>
<div class="settings-body" style="padding: 8px 20px; flex: 1; overflow-y: auto; background: #fdf6f9; min-height: 0;">

    <!-- å¤´åƒè®¾ç½® -->
    <div>
        <div class="settings-section-title">å¤´åƒè®¾ç½®</div>
        <div class="setting-group" style="flex-direction: row; padding: 15px; justify-content: space-around; align-items: center;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                <img id="preview-char-avatar" class="preview-img" src="" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <button class="file-upload-label" onclick="triggerSettingsUpload('char-avatar')" style="font-size: 11px; padding: 4px 8px;">æ›´æ¢å¤´åƒ</button>
                <span style="font-size: 12px; color: #666;">å¯¹æ–¹</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                <img id="preview-user-avatar" class="preview-img" src="" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <button class="file-upload-label" onclick="triggerSettingsUpload('user-avatar')" style="font-size: 11px; padding: 4px 8px;">æ›´æ¢å¤´åƒ</button>
                <span style="font-size: 12px; color: #666;">æˆ‘æ–¹</span>
            </div>
        </div>
    </div>

    <!-- æ°”æ³¡ä¸å­—ä½“ -->
    <div>
        <div class="settings-section-title">æ°”æ³¡ä¸å­—ä½“</div>
        <div class="setting-group">
            <div class="setting-row"><label>å¯¹æ–¹æ°”æ³¡/æ–‡å­—</label> <div><input type="color" id="set-char-bubble" class="color-picker"> <input type="color" id="set-char-text" class="color-picker"></div></div>
            <div class="setting-row"><label>æˆ‘æ–¹æ°”æ³¡/æ–‡å­—</label> <div><input type="color" id="set-user-bubble" class="color-picker"> <input type="color" id="set-user-text" class="color-picker"></div></div>
            <div class="setting-row"><label>å­—ä½“å¤§å°</label> <div><input type="number" id="set-font-size" class="setting-input-sm" placeholder="14" style="width: 60px;"> px</div></div>
        </div>
    </div>

    <!-- é¢œè‰²è®¾ç½® -->
    <div>
        <div class="settings-section-title">é¢œè‰²è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>åå­—/æ—¶é—´</label> <div><input type="color" id="set-msg-name-color" class="color-picker"> <input type="color" id="set-msg-time-color" class="color-picker"></div></div>
            <div class="setting-row"><label>ç•Œé¢</label> <div><input type="color" id="set-interface-color" class="color-picker"></div></div>
        </div>
    </div>

    <!-- æŒ‰é’®è®¾ç½® -->
    <div>
        <div class="settings-section-title">æŒ‰é’®è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>æŒ‰é’®é¢œè‰²</label> <div><input type="color" id="set-chat-btn-text" class="color-picker"></div></div>
        </div>
    </div>

    <!-- æ‹‰é»‘è®¾ç½® -->
    <div>
        <div class="settings-section-title">æ‹‰é»‘è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row">
                <label>æ‹’æ”¶å¯¹æ–¹æ¶ˆæ¯</label> 
                <label class="switch">
                    <input type="checkbox" id="set-block-char">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="setting-row">
                <label>æ¶ˆæ¯è¢«å¯¹æ–¹ç»æ”¶</label> 
                <label class="switch">
                    <input type="checkbox" id="set-block-user">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯è®¾ç½® -->
    <div>
        <div class="settings-section-title">èƒŒæ™¯è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>èŠå¤©èƒŒæ™¯</label> <div><button class="file-upload-label" onclick="triggerSettingsUpload('chat-bg')">ä¸Šä¼ å›¾ç‰‡</button> <img id="preview-chat-bg" class="preview-img" src=""></div></div>
        </div>
    </div>

</div>
<div class="modal-actions" style="padding: 20px; background: transparent; border-top: none; margin: 0; justify-content: space-between;">
<button class="modal-btn btn-cancel" onclick="closeModal()" style="border-radius: 20px; padding: 12px 24px;">å–æ¶ˆ</button>
<button class="modal-btn btn-save" onclick="saveChatSettings()" style="border-radius: 20px; padding: 12px 24px; flex: 1; margin-left: 10px;">ä¿å­˜é…ç½®</button>
</div>
</div>
</div>
</div>
<script>
(function() {
// Global Variables
const defaultAppSettings = {
charBubble: '#FFC9CB', charText: '#474747', charAvatar: '',
userBubble: '#FFA8AC', userText: '#5C5C5C', userAvatar: '',
chatBg: 'https://file.zhuyitai.com/feedback/202511/22/96c39311d8df6d1d6a89984630585a70.jpeg', chatBgIsDark: false,
homeBg: 'https://intellcs.sinosafe.com.cn/immessage/api/v1/message/attachment/download?groupName=group1&authorization=EnAfMjUzaQVz&fileName=M00/00/A7/CgND1WkhtDSADV5WAANPQ4JuHoI63.jpeg', homeBgIsDark: false,
iconBg: '#003673', iconColor: '#00885A',
caseColor: '#707070', phoneWidth: '330', phoneHeight: '660',
homeTextColor: '#749594',
interfaceColor: '#ffc7c8',
msgNameColor: '#858585',
msgTimeColor: '#999999',
fontSize: 14, // é»˜è®¤å­—ä½“å¤§å°
chatBtnColor: '#f2b5b6', // æŒ‰é’®èƒŒæ™¯è‰²
chatBtnText: '#580000', // æŒ‰é’®æ–‡å­—/å›¾æ ‡è‰²
customTime: '', // æ ¼å¼ HH:MMï¼Œä¸ºç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿæ—¶é—´
timeOffset: 0, // æ—¶é—´åç§»é‡ (ms)
blockChar: false, // User blocks Char
blockUser: false, // Char blocks User
};
let appSettings = { ...defaultAppSettings };

let myStickerList = [];
const defaultStickerList = [
{ name: "ä½ è‡ªé¦–å§", url: "https://files.catbox.moe/s1wpw8.jpeg" },
{ name: "æŠ±æŠ±", url: "https://files.catbox.moe/31onrh.jpeg" },
{ name: "è´´è´´", url: "https://files.catbox.moe/ljqszc.jpeg" },
{ name: "æˆ‘è¦å‘ŠçŠ¶", url: "https://files.catbox.moe/icwt52.jpeg" }
];

let activeDeleteBtn = null;
let currentConfirmAction = null;
// NEW: Pending upload file
let pendingFile = null;
// NEW: Last uploaded image for AI vision
let lastUploadedImageForAI = null;
// NEW: Dark Search Flag
let isWaitingForDarkSearch = false;
// NEW: Diary Flag
let isWaitingForDiary = false;

let currentSettingsUploadType = null;

// DOM Elements (Initialized in init to be safe)
let phoneContainer, homeScreen, chatScreen, settingsScreen, messageListScreen, messageListBody, chatMessages, messageInput, sendButton, plusButton, emojiButton, actionMenu, emojiMenu, modal, modalTitle, modalInputsContainer, modalConfirmBtn, chatSettingsModal, headerTitle, clockEl, homeClockEl, statusBar, photoInput, audioInput, videoInput, mediaPreviewBar, previewImage, previewFileIcon, adapterStatus, darkSearchScreen, darkSearchInput, diaryScreen;

// Functions
function openDarkSearch() {
if(homeScreen) homeScreen.classList.add('slide-out');
if(darkSearchScreen) darkSearchScreen.classList.add('visible');
updateStatusBar('dark-search');
}

function closeDarkSearch() {
if(darkSearchScreen) darkSearchScreen.classList.remove('visible');
if(homeScreen) homeScreen.classList.remove('slide-out');
updateStatusBar('home');
}

async function searchDarkWeb() {
const targetName = darkSearchInput && darkSearchInput.value.trim() ? darkSearchInput.value.trim() : (window.charName || '{{char}}');
// const charName = window.charName || '{{char}}';

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
const resultsContainer = document.getElementById('dark-search-results');
if(resultsContainer) resultsContainer.innerHTML = '<div style="color:#ff69b4;text-align:center;margin-top:50px;font-family:monospace;">æ­£åœ¨æ½œå…¥æ•°æ®èŠ‚ç‚¹...<br>Decrypting...</div>';

isWaitingForDarkSearch = true;

const prompt = `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·åœ¨æš—ç½‘æœç´¢APPä¸­è¯•å›¾å·çœ‹ "${targetName}" çš„æœç´¢å†å²ã€‚
è¯·åˆ—å‡º ${targetName} åœ¨æš—ç½‘çš„æœ€è¿‘5æ¡æœç´¢è®°å½•ã€‚
æ ¼å¼è¦æ±‚ï¼š
1. è¯·åŠ¡å¿…å°†æ‰€æœ‰è¾“å‡ºå†…å®¹åŒ…è£¹åœ¨ <jilu:${targetName}> å’Œ </jilu:${targetName}> æ ‡ç­¾ä¸­ã€‚
2. æ¯æ¡è®°å½•ä¸€è¡Œï¼Œå¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
ã€æœç´¢è®°å½•ã€‘æœç´¢å…³é”®è¯æˆ–å†…å®¹
å†…å®¹éœ€ç¬¦åˆ ${targetName} çš„è§’è‰²è®¾å®šï¼ˆé»‘æš—ã€ç¥ç§˜ã€çŒå¥‡ã€ä¸å¯å‘Šäººï¼‰ã€‚
è¯·ç›´æ¥è¾“å‡º5æ¡è®°å½•ï¼Œä¸è¦åŒ…å«å…¶ä»–å¯¹è¯å†…å®¹ã€‚`;

const injects = [
    { role: 'system', content: prompt, position: 'at_depth', depth: 0 }
];

// è°ƒç”¨ generateï¼Œä¸å¸¦ç”¨æˆ·æ–‡æœ¬
if (typeof generate !== 'undefined') {
    generate({ injects: injects, should_stream: false });
} else {
    // Fallback for testing without backend
    setTimeout(() => {
        const mockResp = `<jilu:${targetName}>ã€æœç´¢è®°å½•ã€‘å¦‚ä½•é”€æ¯ç”µå­è¯æ®\nã€æœç´¢è®°å½•ã€‘è´­ä¹°æœªæ³¨å†Œçš„SIMå¡\nã€æœç´¢è®°å½•ã€‘æœ€æ–°çš„åŠ å¯†é€šè®¯è½¯ä»¶\nã€æœç´¢è®°å½•ã€‘æš—ç½‘äº¤æ˜“å¸‚åœºå…¥å£\nã€æœç´¢è®°å½•ã€‘è¿½è¸ªå™¨æ£€æµ‹æ–¹æ³•</jilu:${targetName}>`;
        renderDarkSearchResults(mockResp);
        isWaitingForDarkSearch = false;
    }, 1500);
}
}

function renderDarkSearchResults(text) {
const container = document.getElementById('dark-search-results');
if (!container) return;
container.innerHTML = '';

// Extract content from <jilu:Name> tags
let contentToParse = text;
const tagMatch = text.match(/<jilu:(.*?)>([\s\S]*?)<\/jilu:\1>/i);
if (tagMatch) {
    contentToParse = tagMatch[2].trim();
} else {
    // Fallback: try to find just the content if tag is missing or malformed
    // But strictly we should look for the tag as requested. 
    // Let's be lenient for now.
}

// ç®€å•çš„è§£æé€»è¾‘ï¼Œæå–æ‰€æœ‰ç¬¦åˆæ ¼å¼çš„è¡Œ
// æ ¼å¼ï¼šã€æœç´¢è®°å½•ã€‘å†…å®¹
const lines = contentToParse.split('\n');
let count = 0;
lines.forEach(line => {
    const match = line.match(/^[\[ã€]æœç´¢è®°å½•[\]ã€‘](.*)$/);
    if (match) {
        const content = match[1].trim();
        
        const item = document.createElement('div');
        item.className = 'dark-result-item';
        item.innerHTML = `
            <div class="dark-result-content">${content}</div>
        `;
        container.appendChild(item);
        count++;
    }
});

if (count === 0) {
     container.innerHTML = '<div style="color:#666;text-align:center;margin-top:50px;">æ— ç›¸å…³æ•°æ®</div>';
}
}

function openDiary() {
    if(homeScreen) homeScreen.classList.add('slide-out');
    if(diaryScreen) diaryScreen.classList.add('visible');
    updateStatusBar('diary');
}

function closeDiary() {
    if(diaryScreen) diaryScreen.classList.remove('visible');
    if(homeScreen) homeScreen.classList.remove('slide-out');
    updateStatusBar('home');
}

async function generateDiary() {
    const nameInput = document.getElementById('diary-target-name');
    const targetName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : (window.charName || '{{char}}');
    
    // Show loading state
    const lockContainer = document.getElementById('diary-lock-container');
    const contentContainer = document.getElementById('diary-content');
    
    if(lockContainer) lockContainer.style.display = 'none';
    if(contentContainer) {
        contentContainer.style.display = 'flex';
        contentContainer.innerHTML = '<div style="text-align:center;margin-top:50px;color:#999;">æ­£åœ¨ç”Ÿæˆæ—¥è®°...</div>';
    }

    isWaitingForDiary = true;

    const prompt = `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·åœ¨æ—¥è®°APPä¸­ç‚¹å‡»äº†è§£é”ã€‚
è¯·ç”Ÿæˆ ${targetName} çš„3ç¯‡ç§å¯†æ—¥è®°ã€‚
æ ¼å¼è¦æ±‚ï¼š
1. è¯·åŠ¡å¿…å°†æ‰€æœ‰è¾“å‡ºå†…å®¹åŒ…è£¹åœ¨ <riji:${targetName}> å’Œ </riji:${targetName}> æ ‡ç­¾ä¸­ã€‚
2. æ¯ç¯‡æ—¥è®°ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
ã€æ—¥è®°|æ—¥æœŸ|å¤©æ°”ã€‘æ—¥è®°å†…å®¹
æ—¥æœŸè¯·æ ¹æ®å½“å‰å‰§æƒ…æˆ–éšæœºç”Ÿæˆï¼ˆå¦‚"11æœˆ24æ—¥"ï¼‰ï¼Œä¸è¦å…¨éƒ¨ä½¿ç”¨ä»Šå¤©ã€‚
å†…å®¹éœ€ç¬¦åˆ ${targetName} çš„è§’è‰²è®¾å®šï¼Œå¯ä»¥æ˜¯æ—¥å¸¸çäº‹ã€å†…å¿ƒç‹¬ç™½æˆ–ç§˜å¯†ã€‚
æ”¯æŒMarkdownæ ¼å¼ï¼ˆå¦‚**åŠ ç²—**ï¼Œ~~åˆ é™¤çº¿~~ï¼Œ# æ ‡é¢˜ï¼‰ã€‚
è¯·ç›´æ¥è¾“å‡º3ç¯‡æ—¥è®°ï¼Œä¸è¦åŒ…å«å…¶ä»–å¯¹è¯å†…å®¹ã€‚`;

    const injects = [
        { role: 'system', content: prompt, position: 'at_depth', depth: 0 }
    ];

    if (typeof generate !== 'undefined') {
        generate({ injects: injects, should_stream: false });
    } else {
        // Fallback
        setTimeout(() => {
            const mockResp = `<riji:${targetName}>ã€æ—¥è®°|11æœˆ20æ—¥|é˜´ã€‘ä»Šå¤©å¿ƒæƒ…å¾ˆå·®ï¼Œ**ä¸æƒ³è¯´è¯**ã€‚\nã€æ—¥è®°|11æœˆ22æ—¥|é›¨ã€‘~~é‚£ä¸ªç¬¨è›‹~~åˆæ¥çƒ¦æˆ‘äº†ã€‚\nã€æ—¥è®°|11æœˆ25æ—¥|æ™´ã€‘# è®¡åˆ’\n1. ä¹°ä¸œè¥¿\n2. ç¡è§‰</riji:${targetName}>`;
            renderDiaryEntries(mockResp);
            isWaitingForDiary = false;
        }, 1500);
    }
}

function renderDiaryEntries(text) {
    const container = document.getElementById('diary-content');
    if (!container) return;
    container.innerHTML = '';
    
    // Extract content from <riji:Name> tags if present
    let contentToParse = text;
    const tagMatch = text.match(/<riji:(.*?)>([\s\S]*?)<\/riji:\1>/i);
    if (tagMatch) {
        contentToParse = tagMatch[2].trim();
    }
    
    // Simple markdown parser
    const parseMarkdown = (str) => {
        let html = str
            .replace(/^# (.*$)/gim, '<h3>$1</h3>')
            .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
            .replace(/~~(.*)~~/gim, '<del>$1</del>')
            .replace(/\n/gim, '<br>');
        return html;
    };

    let entries = [];
    
    // Split by the header pattern
    const parts = contentToParse.split(/([\[ã€]æ—¥è®°\|.*?\|.*?[\]ã€‘])/);
    
    for (let i = 1; i < parts.length; i += 2) {
        const headerStr = parts[i];
        const contentStr = parts[i+1];
        
        const headerMatch = headerStr.match(/[\[ã€]æ—¥è®°\|(.*?)\|(.*?)[\]ã€‘]/);
        if (headerMatch) {
            entries.push({
                date: headerMatch[1],
                weather: headerMatch[2],
                content: contentStr.trim()
            });
        }
    }
    
    // Fallback for simple line parsing if split failed (e.g. single line response)
    if (entries.length === 0) {
         const lines = text.split('\n');
         lines.forEach(line => {
             const match = line.match(/^[\[ã€]æ—¥è®°\|(.*?)\|(.*?)[\]ã€‘](.*)$/);
             if (match) {
                 entries.push({
                     date: match[1],
                     weather: match[2],
                     content: match[3].trim()
                 });
             }
         });
    }

    entries.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'diary-card';
        
        card.innerHTML = `
            <div class="diary-header">
                <span class="diary-date">${entry.date}</span>
                <span class="diary-weather">${entry.weather}</span>
            </div>
            <div class="diary-body">
                ${parseMarkdown(entry.content)}
            </div>
        `;
        container.appendChild(card);
    });
    
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align:center;margin-top:50px;color:#d4a5a5;font-family:\'Ma Shan Zheng\';">æ—¥è®°æœ¬æ˜¯ç©ºçš„...<br>(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)</div>';
    }
}

function openMessageList() {
if(homeScreen) homeScreen.classList.add('slide-out');
if(messageListScreen) messageListScreen.classList.add('visible');
updateStatusBar('message-list');
renderMessageList();
}

function openChat() {
// ä»æ¶ˆæ¯åˆ—è¡¨è¿›å…¥èŠå¤©
if(chatScreen) chatScreen.classList.add('visible');
updateStatusBar('chat');
setTimeout(() => { if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight; }, 300);
}

function goBack() {
closeMenus();
if(chatScreen && chatScreen.classList.contains('visible')) {
    // ä»èŠå¤©è¿”å›æ¶ˆæ¯åˆ—è¡¨
    chatScreen.classList.remove('visible');
    updateStatusBar('message-list');
    renderMessageList(); // åˆ·æ–°é¢„è§ˆ
    return;
}

if(messageListScreen && messageListScreen.classList.contains('visible')) {
    // ä»æ¶ˆæ¯åˆ—è¡¨è¿”å›ä¸»å±å¹•
    messageListScreen.classList.remove('visible');
    if(homeScreen) homeScreen.classList.remove('slide-out');
    updateStatusBar('home');
    return;
}

if(settingsScreen && settingsScreen.classList.contains('visible')) {
    settingsScreen.classList.remove('visible');
    if(homeScreen) homeScreen.classList.remove('slide-out');
    updateStatusBar('home');
    return;
}

// Fallback
if(homeScreen) homeScreen.classList.remove('slide-out');
updateStatusBar('home');
}

function renderMessageList() {
if(!messageListBody) return;
messageListBody.innerHTML = '';

const charName = window.charName || '{{char}}';
const avatar = appSettings.charAvatar;

// è·å–æœ€åä¸€æ¡æ¶ˆæ¯
let lastMsg = 'ç‚¹å‡»å¼€å§‹èŠå¤©';
let lastTime = '';

try {
    if (typeof getCurrentMessageId !== 'undefined') {
         const h = getChatMessages(getCurrentMessageId());
         if (h && h[0] && h[0].message) {
             const m = h[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i);
             if (m) {
                 const c = m[1].replace(/<\/?chat(:.*?)?>/gi, '').trim();
                 const msgs = parseMessages(c);
                 // è¿‡æ»¤æ‰æš—ç½‘æœç´¢è®°å½•å’Œæ—¥è®°
                 const validMsgs = msgs.filter(m => {
                     if (m.header && (m.header.includes('ã€æœç´¢è®°å½•') || m.header.includes('ã€æ—¥è®°') || m.type === 'search-history')) return false;
                     if (m.body && (m.body.startsWith('ã€æ—¥è®°') || m.body.startsWith('ã€æœç´¢è®°å½•'))) return false;
                     return true;
                 });
                 
                 if (validMsgs.length > 0) {
                     const last = validMsgs[validMsgs.length - 1];
                     if (last.type === 'text') lastMsg = last.body;
                     else if (last.type === 'photo') lastMsg = '[å›¾ç‰‡]';
                     else if (last.type === 'sticker') lastMsg = '[è¡¨æƒ…åŒ…]';
                     else if (last.type === 'voice') lastMsg = '[è¯­éŸ³]';
                     else if (last.type === 'file') lastMsg = '[æ–‡ä»¶]';
                     else if (last.type === 'location') lastMsg = '[ä½ç½®]';
                     else if (last.type === 'transfer') lastMsg = '[è½¬è´¦]';
                     else if (last.type === 'transfer') lastMsg = '[è½¬è´¦]';
                     else lastMsg = '[æ¶ˆæ¯]';
                     
                     // å°è¯•ä» header è·å–æ—¶é—´
                     if (last.header) {
                         const parts = last.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
                         if (parts.length > 1) lastTime = parts[parts.length - 1];
                     }
                 }
             }
         }
    }
} catch(e) {}

try {
    if (typeof getCurrentMessageId !== 'undefined') {
         const h = getChatMessages(getCurrentMessageId());
         if (h && h[0] && h[0].message) {
             const m = h[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i);
             if (m) {
                 const c = m[1].replace(/<\/?chat(:.*?)?>/gi, '').trim();
                 const msgs = parseMessages(c);
                 if (msgs.length > 0) {
                     const last = msgs[msgs.length - 1];
                     if (last.type === 'text') lastMsg = last.body;
                     else if (last.type === 'photo') lastMsg = '[å›¾ç‰‡]';
                     else if (last.type === 'sticker') lastMsg = '[è¡¨æƒ…åŒ…]';
                     else if (last.type === 'voice') lastMsg = '[è¯­éŸ³]';
                     else if (last.type === 'file') lastMsg = '[æ–‡ä»¶]';
                     else if (last.type === 'location') lastMsg = '[ä½ç½®]';
                     else if (last.type === 'transfer') lastMsg = '[è½¬è´¦]';
                     else lastMsg = '[æ¶ˆæ¯]';
                     
                     // å°è¯•ä» header è·å–æ—¶é—´
                     if (last.header) {
                         const parts = last.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
                         if (parts.length > 1) lastTime = parts[parts.length - 1];
                     }
                 }
             }
         }
    }
} catch(e) {}

if (!lastTime) lastTime = getTime();

const item = document.createElement('div');
item.className = 'message-list-item';
item.onclick = openChat;

item.innerHTML = `
    <img class="message-list-avatar" src="${avatar}">
    <div class="message-list-info">
        <div class="message-list-top">
            <span class="message-list-name">${charName}</span>
            <span class="message-list-time">${lastTime}</span>
        </div>
        <div class="message-list-preview">${lastMsg}</div>
    </div>
`;
messageListBody.appendChild(item);
}

function openSettings() {
document.getElementById('set-phone-w').value = appSettings.phoneWidth;
document.getElementById('set-phone-h').value = appSettings.phoneHeight;
document.getElementById('set-case-color').value = appSettings.caseColor;
document.getElementById('set-icon-bg').value = appSettings.iconBg;
document.getElementById('set-icon-color').value = appSettings.iconColor;
document.getElementById('set-home-text-color').value = appSettings.homeTextColor;

// Calculate current custom time for display
let displayTime = '';
if (appSettings.timeOffset) {
    const now = new Date();
    const target = new Date(now.getTime() + appSettings.timeOffset);
    displayTime = `${target.getHours().toString().padStart(2,'0')}:${target.getMinutes().toString().padStart(2,'0')}`;
} else {
    displayTime = appSettings.customTime || '';
}
document.getElementById('set-custom-time').value = displayTime;

document.getElementById('preview-home-bg').src = appSettings.homeBg || '';

// æ£€æŸ¥é€‚é…å™¨æ’ä»¶è¿æ¥çŠ¶æ€
const statusEl = document.getElementById('adapter-status');
if (statusEl) {
    if (window.parent && window.parent.__fayePhoneSupport_upload) {
        statusEl.textContent = "â— å·²è¿æ¥";
        statusEl.style.color = "green";
    } else {
        statusEl.textContent = "â—‹ æœªæ£€æµ‹åˆ°æ’ä»¶";
        statusEl.style.color = "#999";
    }
}

if(homeScreen) homeScreen.classList.add('slide-out');
if(settingsScreen) settingsScreen.classList.add('visible');
updateStatusBar('settings');
}

function closeSettings() {
if(settingsScreen) settingsScreen.classList.remove('visible');
if(homeScreen) homeScreen.classList.remove('slide-out');
updateStatusBar('home');
}

function updateClock() {
let timeStr;
if (appSettings.timeOffset) {
    const now = new Date();
    const target = new Date(now.getTime() + appSettings.timeOffset);
    timeStr = `${target.getHours().toString().padStart(2,'0')}:${target.getMinutes().toString().padStart(2,'0')}`;
} else if (appSettings.customTime && /^\d{1,2}:\d{2}$/.test(appSettings.customTime)) {
    timeStr = appSettings.customTime;
} else {
    const now = new Date();
    timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}
if(clockEl) clockEl.textContent = timeStr;
if(homeClockEl) homeClockEl.textContent = timeStr;
}

function updateStatusBar(screen) {
let isDark = false;
if (screen === 'home') isDark = appSettings.homeBgIsDark;
else if (screen === 'chat') isDark = appSettings.chatBgIsDark;
else if (screen === 'settings') isDark = false;
else if (screen === 'message-list') isDark = false;
else if (screen === 'dark-search') isDark = false;

if (screen === 'home' && !appSettings.homeBg) isDark = false;
if (screen === 'chat' && !appSettings.chatBg) isDark = false;

if(statusBar) statusBar.className = isDark ? 'status-bar text-light' : 'status-bar text-dark';
}

function analyzeImageBrightness(base64) {
return new Promise((resolve) => {
if (!base64) { resolve(false); return; }
const img = new Image();
img.crossOrigin = 'Anonymous';
img.src = base64;
img.onload = () => {
const canvas = document.createElement('canvas'); canvas.width = 50; canvas.height = 50;
const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 50, 50);
try {
const data = ctx.getImageData(0,0,50,50).data; let r=0,g=0,b=0;
for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
resolve(((r+g+b)/(3*(data.length/4))) < 128);
} catch (e) { resolve(false); }
};
img.onerror = () => resolve(false);
});
}

let lastStorageKey = null;

function getStorageKey() {
    try {
        // 1. ä¼˜å…ˆä½¿ç”¨æ’ä»¶æä¾›çš„ç¨³å®š ID
        if (window.parent && window.parent.__fayePhoneSupport_getCharInfo) {
            const info = window.parent.__fayePhoneSupport_getCharInfo();
            if (info && info.storageKey) {
                // é¡ºä¾¿æ›´æ–°å…¨å±€è§’è‰²åï¼Œç”¨äºæ˜¾ç¤º
                if (info.name) window.charName = info.name;
                return `st-phone-settings-${info.storageKey}`;
            }
        }
    } catch(e) {}
    
    // 2. å›é€€åˆ°åŸºäºåå­—çš„ Key
    const name = getCurrentCharacterName();
    if (name && name !== '{{char}}') {
        window.charName = name;
        return `st-phone-settings-${name}`;
    }
    
    return 'st-phone-settings-global';
}

function loadSettings() {
    const key = getStorageKey();
    const charName = window.charName; // getStorageKey ä¼šæ›´æ–°è¿™ä¸ªå€¼

    // 1. Reset to defaults
    appSettings = { ...defaultAppSettings };
    
    // 2. Load Settings
    const saved = localStorage.getItem(key);
    if (saved) {
        try { 
            const parsed = JSON.parse(saved);
            appSettings = { ...appSettings, ...parsed }; 
            // ç¡®ä¿æ‹‰é»‘çŠ¶æ€è¢«æ­£ç¡®åŠ è½½
            if (typeof parsed.blockChar !== 'undefined') appSettings.blockChar = parsed.blockChar;
            if (typeof parsed.blockUser !== 'undefined') appSettings.blockUser = parsed.blockUser;
            // ç¡®ä¿è‡ªå®šä¹‰æ—¶é—´è¢«æ­£ç¡®åŠ è½½
            if (typeof parsed.customTime !== 'undefined') appSettings.customTime = parsed.customTime;
            if (typeof parsed.timeOffset !== 'undefined') appSettings.timeOffset = parsed.timeOffset;
        } catch(e) {}
    }

    // 3. Validate Paths: Ensure we don't use assets from other characters
    if (charName) {
        const validatePath = (path, defaultVal) => {
            if (!path || typeof path !== 'string' || !path.includes('/user/images/')) return path;
            try {
                const decoded = decodeURI(path);
                // åŒ¹é… /user/images/è§’è‰²å/
                const match = decoded.match(/\/user\/images\/([^/]+)\//);
                if (match && match[1]) {
                    // å¦‚æœè·¯å¾„ä¸­çš„è§’è‰²åä¸å½“å‰è§’è‰²åä¸ä¸€è‡´ï¼Œåˆ™è§†ä¸ºæ— æ•ˆ
                    if (match[1] !== charName) {
                        return defaultVal;
                    }
                }
            } catch(e) {}
            return path;
        };

        appSettings.chatBg = validatePath(appSettings.chatBg, defaultAppSettings.chatBg);
        appSettings.homeBg = validatePath(appSettings.homeBg, defaultAppSettings.homeBg);
        appSettings.charAvatar = validatePath(appSettings.charAvatar, defaultAppSettings.charAvatar);
        appSettings.userAvatar = validatePath(appSettings.userAvatar, defaultAppSettings.userAvatar);
    }
}

// Helper to get robust character name
function getCurrentCharacterName() {
    try {
        if (window.parent && window.parent.TavernHelper) {
            // 1. Try RawCharacter (Most reliable if available)
            if (window.parent.TavernHelper.RawCharacter && window.parent.TavernHelper.RawCharacter.find) {
                const char = window.parent.TavernHelper.RawCharacter.find({name: 'current'});
                if (char && char.name) return char.name;
            }
            // 2. Fallback to getCharData
            const charData = window.parent.TavernHelper.getCharData('current');
            if (charData && charData.name) return charData.name;
        }
    } catch (e) { console.error("Error getting char name:", e); }
    
    // 3. Fallback to window.charName
    if (window.charName && window.charName !== '{{char}}') return window.charName;
    
    // 4. Fallback to DOM title
    const titleEl = document.getElementById('header-title');
    if (titleEl && titleEl.textContent && titleEl.textContent !== '{{char}}') return titleEl.textContent;
    
    return null;
}

function saveSettingsToStorage() { 
    const key = getStorageKey();
    localStorage.setItem(key, JSON.stringify(appSettings));
}

async function checkCharacterChange() {
    const currentKey = getStorageKey();
    if (!currentKey) return;
    
    if (lastStorageKey !== currentKey) {
        lastStorageKey = currentKey;
        
        // Update UI Title
        if (window.charName && headerTitle) headerTitle.textContent = window.charName;
        
        // Reload settings for new character
        loadSettings();
        
        // Update Avatar from Tavern
        if (window.parent && window.parent.TavernHelper) {
            const avatarUrl = window.parent.TavernHelper.getCharAvatarPath('current');
            if (avatarUrl && !appSettings.charAvatar) {
                appSettings.charAvatar = `${avatarUrl}?t=${Date.now()}`;
            }
        }
        
        applySettings();
        updateClock(); // ç¡®ä¿æ—¶é—´ç«‹å³æ›´æ–°
        
        // Reload chat history for new character
        try { loadInitialChat(); } catch(e){}
    }
}


function hexToRgba(hex, alpha) {
let r = 0, g = 0, b = 0;
if (hex.length === 4) {
r = parseInt("0x" + hex[1] + hex[1]);
g = parseInt("0x" + hex[2] + hex[2]);
b = parseInt("0x" + hex[3] + hex[3]);
} else if (hex.length === 7) {
r = parseInt("0x" + hex[1] + hex[2]);
g = parseInt("0x" + hex[3] + hex[4]);
b = parseInt("0x" + hex[5] + hex[6]);
}
return `rgba(${r},${g},${b},${alpha})`;
}

function applySettings() {
if(phoneContainer) {
phoneContainer.style.width = (appSettings.phoneWidth || 350) + 'px';
phoneContainer.style.height = (appSettings.phoneHeight || 650) + 'px';
phoneContainer.style.borderColor = appSettings.caseColor;
phoneContainer.style.backgroundColor = appSettings.caseColor; // ä¿®å¤åœ†è§’ç¼éš™ï¼šèƒŒæ™¯è‰²è·Ÿéšæ‰‹æœºå£³é¢œè‰²
}
if(homeScreen) {
if (appSettings.homeBg) homeScreen.style.backgroundImage = `url(${appSettings.homeBg})`;
else { homeScreen.style.backgroundImage = 'none'; homeScreen.style.backgroundColor = '#f3e5f5'; }
}
if(chatScreen) {
if (appSettings.chatBg) { chatScreen.style.backgroundImage = `url(${appSettings.chatBg})`; chatScreen.style.backgroundColor = '#f9f9f9'; }
else { chatScreen.style.backgroundImage = 'none'; chatScreen.style.backgroundColor = '#fff'; }
}

document.querySelectorAll('.app-icon-style').forEach(el => {
el.style.background = appSettings.iconBg;
const svg = el.querySelector('svg');
if (svg) svg.style.fill = appSettings.iconColor;
const mask = el.querySelector('.app-icon-image');
if (mask) mask.style.backgroundColor = appSettings.iconColor;
});

if (appSettings.homeTextColor) {
if(homeClockEl) homeClockEl.style.color = appSettings.homeTextColor;
document.querySelectorAll('.app-name').forEach(el => el.style.color = appSettings.homeTextColor);
}

const rootStyle = document.documentElement.style;
const rgba = hexToRgba(appSettings.interfaceColor || '#f7f7f7', 0.6);
rootStyle.setProperty('--interface-bg', rgba);
rootStyle.setProperty('--msg-name-color', appSettings.msgNameColor || '#999999');
rootStyle.setProperty('--msg-time-color', appSettings.msgTimeColor || '#b0b0b0');
rootStyle.setProperty('--msg-font-size', (appSettings.fontSize || 14) + 'px');
const btnRgba = hexToRgba(appSettings.chatBtnColor || '#f2b5b6', 0.6);
rootStyle.setProperty('--chat-btn-color', btnRgba);
rootStyle.setProperty('--chat-btn-text', appSettings.chatBtnText || '#2ea0a0');

updateStatusBar('home'); loadInitialChat();
}

function handleUploadUrl(targetId) {
openModal('è¾“å…¥å›¾ç‰‡é“¾æ¥', [{ placeholder: 'https://...' }], (values) => {
const url = values[0];
if (url) {
const el = document.getElementById('preview-' + targetId);
if (el) el.src = url;
}
});
}

async function saveHomeSettings() {
appSettings.phoneWidth = document.getElementById('set-phone-w').value || 350;
appSettings.phoneHeight = document.getElementById('set-phone-h').value || 650;
appSettings.caseColor = document.getElementById('set-case-color').value;
appSettings.iconBg = document.getElementById('set-icon-bg').value;
appSettings.iconColor = document.getElementById('set-icon-color').value;
appSettings.homeTextColor = document.getElementById('set-home-text-color').value;

const timeInput = document.getElementById('set-custom-time').value;
if (timeInput && /^\d{1,2}:\d{2}$/.test(timeInput)) {
    const now = new Date();
    const [h, m] = timeInput.split(':');
    const target = new Date(now);
    target.setHours(parseInt(h));
    target.setMinutes(parseInt(m));
    target.setSeconds(0);
    // Calculate offset: Target Time - Real Time
    appSettings.timeOffset = target.getTime() - now.getTime();
    appSettings.customTime = timeInput; 
} else {
    appSettings.timeOffset = 0;
    appSettings.customTime = '';
}

const homeBgUrl = document.getElementById('preview-home-bg').src;
if (homeBgUrl && homeBgUrl !== window.location.href) {
appSettings.homeBg = homeBgUrl;
appSettings.homeBgIsDark = await analyzeImageBrightness(appSettings.homeBg);
}
saveSettingsToStorage(); applySettings(); closeSettings();
}

function openChatSettings() {
document.getElementById('set-char-bubble').value = appSettings.charBubble;
document.getElementById('set-char-text').value = appSettings.charText;
document.getElementById('set-user-bubble').value = appSettings.userBubble;
document.getElementById('set-user-text').value = appSettings.userText;
document.getElementById('preview-char-avatar').src = appSettings.charAvatar;
document.getElementById('preview-user-avatar').src = appSettings.userAvatar;
document.getElementById('preview-chat-bg').src = appSettings.chatBg || '';
document.getElementById('set-interface-color').value = appSettings.interfaceColor || '#f7f7f7';
document.getElementById('set-msg-name-color').value = appSettings.msgNameColor || '#999999';
document.getElementById('set-msg-time-color').value = appSettings.msgTimeColor || '#b0b0b0';
document.getElementById('set-font-size').value = appSettings.fontSize || 14;
document.getElementById('set-chat-btn-text').value = appSettings.chatBtnText || '#2ea0a0';
document.getElementById('set-block-char').checked = appSettings.blockChar || false;
document.getElementById('set-block-user').checked = appSettings.blockUser || false;
chatSettingsModal.classList.add('show');
}

async function saveChatSettings() {
appSettings.charBubble = document.getElementById('set-char-bubble').value;
appSettings.charText = document.getElementById('set-char-text').value;
appSettings.userBubble = document.getElementById('set-user-bubble').value;
appSettings.userText = document.getElementById('set-user-text').value;
appSettings.interfaceColor = document.getElementById('set-interface-color').value;
appSettings.msgNameColor = document.getElementById('set-msg-name-color').value;
appSettings.msgTimeColor = document.getElementById('set-msg-time-color').value;
appSettings.fontSize = parseInt(document.getElementById('set-font-size').value) || 14;
appSettings.chatBtnText = document.getElementById('set-chat-btn-text').value;
appSettings.blockChar = document.getElementById('set-block-char').checked;
appSettings.blockUser = document.getElementById('set-block-user').checked;

const charAvatarUrl = document.getElementById('preview-char-avatar').src;
if (charAvatarUrl) appSettings.charAvatar = charAvatarUrl;
const userAvatarUrl = document.getElementById('preview-user-avatar').src;
if (userAvatarUrl) appSettings.userAvatar = userAvatarUrl;
const chatBgUrl = document.getElementById('preview-chat-bg').src;
if (chatBgUrl && chatBgUrl !== window.location.href) {
appSettings.chatBg = chatBgUrl;
appSettings.chatBgIsDark = await analyzeImageBrightness(appSettings.chatBg);
}
saveSettingsToStorage(); applySettings(); closeModal(); closeMenus();
}

function closeModal() {
// If input modal is visible, close ONLY the input modal
if(modal && modal.classList.contains('show')) {
modal.classList.remove('show');
currentConfirmAction = null; // Cleanup current action
return;
}
// If input modal is not visible, close the settings modal
if(chatSettingsModal && chatSettingsModal.classList.contains('show')) {
chatSettingsModal.classList.remove('show');
}
currentConfirmAction = null;
}
function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }

function closeMenus() {
if(actionMenu) actionMenu.classList.remove('open');
if(plusButton) plusButton.classList.remove('active');
if(emojiMenu) emojiMenu.classList.remove('open');
}

function initStickers() {
if(!emojiMenu) return;
emojiMenu.innerHTML = '';
const addBtn = document.createElement('div');
addBtn.className = 'sticker-item';
addBtn.onclick = handleAddSticker;
addBtn.innerHTML = `<div class="sticker-add-btn"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></div><span class="sticker-name">æ·»åŠ </span>`;
emojiMenu.appendChild(addBtn);

myStickerList.forEach((s, index) => {
const div = document.createElement('div');
div.className = 'sticker-item';
div.onclick = () => { if(!div.classList.contains('delete-mode')) sendSticker(s.name, s.url); };
div.innerHTML = `<img src="${s.url}" class="sticker-img"><span class="sticker-name">${s.name}</span>`;
addStickerLongPressHandler(div, index);
emojiMenu.appendChild(div);
});
}

function handleAddSticker() {
openModal('æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…', [{ placeholder: 'æ ¼å¼: åå­—1é“¾æ¥1,åå­—2é“¾æ¥2' }], (values) => {
const input = values[0];
if(!input) return;
const items = input.split(/,|ï¼Œ/);
let addedCount = 0;
items.forEach(item => {
item = item.trim();
if(!item) return;
const match = item.match(/^(.*?)(https?:\/\/.*)$/);
if(match) {
const name = match[1].trim() || 'è¡¨æƒ…';
const url = match[2].trim();
myStickerList.unshift({ name, url });
addedCount++;
}
});
if(addedCount > 0) { saveStickers(); initStickers(); }
});
}

function saveStickers() { localStorage.setItem('st-phone-stickers', JSON.stringify(myStickerList)); }

function addStickerLongPressHandler(el, index) {
let timer;
const start = (e) => {
if(e.target.closest('.delete-btn')) return;
el.classList.add('pressing');
timer = setTimeout(() => { el.classList.remove('pressing'); showStickerDeleteButton(el, index); }, 500);
};
const cancel = () => { clearTimeout(timer); el.classList.remove('pressing'); };
el.addEventListener('mousedown', start);
el.addEventListener('touchstart', start, {passive:true});
['mouseup','mouseleave','touchend','touchmove'].forEach(ev => el.addEventListener(ev, cancel));
}

function showStickerDeleteButton(el, index) {
document.querySelectorAll('.sticker-item .delete-btn').forEach(b => b.remove());
document.querySelectorAll('.sticker-item.delete-mode').forEach(i => i.classList.remove('delete-mode'));
el.classList.add('delete-mode');
const btn = document.createElement('div');
btn.className = 'delete-btn';
btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
btn.onclick = (e) => { e.stopPropagation(); myStickerList.splice(index, 1); saveStickers(); initStickers(); };
el.appendChild(btn);
}

function handleAction(type) {
if (type === 'location') openModal('å‘é€ä½ç½®', [{ placeholder: 'åœ°ç‚¹åç§°' }], (v) => sendLocation(v[0]));
else if (type === 'transfer') openModal('è½¬è´¦ç»™å¯¹æ–¹', [{ placeholder: 'é‡‘é¢ (å¦‚ï¼šÂ¥ 520.00)' }, { placeholder: 'å¤‡æ³¨ (å¯é€‰)' }], (v) => sendTransfer(v[0], v[1]));
else if (type === 'file') openModal('å‘é€æ–‡ä»¶', [{ placeholder: 'æ–‡ä»¶åç§° (å¦‚ï¼šæŠ¥å‘Š.pdf)' }], (v) => sendFile(v[0]));
else if (type === 'voice') {
    openModal('å‘é€è¯­éŸ³', [{ placeholder: 'æ—¶é•¿ (ç§’)' }, { placeholder: 'è½¬æ–‡å­—å†…å®¹' }], (v) => sendVoice(v[0], v[1]));
}
else if (type === 'settings') openChatSettings();
else if (type === 'photo') { if(photoInput) photoInput.click(); }
else if (type === 'call') { /* ç¦ç”¨ */ }
else if (type === 'camera') { if(videoInput) videoInput.click(); }
}

function openModal(title, fields, confirmCallback) {
modalTitle.textContent = title; modalInputsContainer.innerHTML = '';
fields.forEach(field => { const input = document.createElement('input'); input.type = 'text'; input.className = 'modal-input'; input.placeholder = field.placeholder; modalInputsContainer.appendChild(input); });
currentConfirmAction = confirmCallback; modal.classList.add('show');
}

async function sendLocation(addr) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|ä½ç½®|${t}|!]` : `[${u}|ä½ç½®|${t}]`; renderMessageToUI({ header: h, body: addr, isUser: true, type: 'location' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendTransfer(amt, note) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|è½¬è´¦|${t}|!]` : `[${u}|è½¬è´¦|${t}]`; renderMessageToUI({ header: h, body: `${amt}|${note||''}`, isUser: true, type: 'transfer' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendFile(fn) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|æ–‡ä»¶|${t}|!]` : `[${u}|æ–‡ä»¶|${t}]`; renderMessageToUI({ header: h, body: fn, isUser: true, type: 'file' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendVoice(dur, txt) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|è¯­éŸ³|${t}|!]` : `[${u}|è¯­éŸ³|${t}]`; renderMessageToUI({ header: h, body: `${dur}|${txt||''}`, isUser: true, type: 'voice' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendPhoto(base64) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|å›¾ç‰‡|${t}]`, body: base64, isUser: true, type: 'photo' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendRealAudio(url) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|è¯­éŸ³|${t}]`, body: url, isUser: true, type: 'voice' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendVideo(url) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|è§†é¢‘|${t}]`, body: url, isUser: true, type: 'video' }); await rebuildAndSaveHistory(); } catch (e) {} }


async function sendSticker(name, url) {
const filename = url.split('/').pop();
const bodyText = name + filename;
const t = getTime();
const u = window.userName || '{{user}}';
renderMessageToUI({ header: `[${u}|è¡¨æƒ…åŒ…|${t}]`, body: bodyText, isUser: true, type: 'sticker' });
await rebuildAndSaveHistory();
}

// é¢„è§ˆå’Œå‘é€æ–‡ä»¶ç›¸å…³
function handleFileSelect(file) {
    if (!file) return;
    pendingFile = file;
    
    // æ˜¾ç¤ºé¢„è§ˆæ¡
    if (mediaPreviewBar) mediaPreviewBar.classList.add('visible');
    
    // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œè¯»å–å¹¶æ˜¾ç¤ºç¼©ç•¥å›¾
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            if (previewImage) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            }
            if (previewFileIcon) previewFileIcon.style.display = 'none';
        };
        reader.readAsDataURL(file);
    } 
    // å¦‚æœæ˜¯éŸ³é¢‘ï¼Œæ˜¾ç¤ºéŸ³ç¬¦å›¾æ ‡
    else if (file.type.startsWith('audio/')) {
        if (previewImage) previewImage.style.display = 'none';
        if (previewFileIcon) {
            previewFileIcon.textContent = 'ğŸµ';
            previewFileIcon.style.display = 'block';
        }
    }
    // å¦‚æœæ˜¯è§†é¢‘ï¼Œæ˜¾ç¤ºè§†é¢‘å›¾æ ‡
    else if (file.type.startsWith('video/')) {
        if (previewImage) previewImage.style.display = 'none';
        if (previewFileIcon) {
            previewFileIcon.textContent = 'ğŸ¬';
            previewFileIcon.style.display = 'block';
        }
    }
}

// å…¨å±€æš´éœ²æ¸…ç†å‡½æ•°
window.clearPreview = function() {
    pendingFile = null;
    if (mediaPreviewBar) mediaPreviewBar.classList.remove('visible');
    if (photoInput) photoInput.value = '';
    if (audioInput) audioInput.value = '';
}


async function sendMessage() {
closeMenus(); 
const text = messageInput.value.trim();

// è®°å½•æ˜¯å¦åˆšå‘é€äº†æ–‡ä»¶
let fileSent = false;

// 1. å¤„ç†æ–‡ä»¶ä¸Šä¼  (å¦‚æœæœ‰)
if (pendingFile) {
    fileSent = true;
    // æ£€æŸ¥æ˜¯å¦æœ‰é€‚é…å™¨æ’ä»¶
    if (window.parent && window.parent.__fayePhoneSupport_upload) {
        try {
            // è·å–è§’è‰²å
            let cName = 'default';
            
            // å°è¯•ä»çˆ¶çª—å£è·å–å‡†ç¡®çš„è§’è‰²å
            if (window.parent && window.parent.SillyTavern) {
                try {
                    const ctx = window.parent.SillyTavern.getContext();
                    if (ctx) {
                        let chars = ctx.characters;
                        // Handle Promise
                        if (chars && typeof chars.then === 'function') {
                             chars = await chars;
                        }
                        if (chars && ctx.characterId && chars[ctx.characterId]) {
                            cName = chars[ctx.characterId].name;
                        }
                    }
                } catch(e) { console.log('Parent context unavailable in sendMessage'); }
            }

            // å›é€€åˆ° DOM
            if (!cName || cName === 'default' || cName === '{{char}}') {
                const titleEl = document.getElementById('header-title');
                if (titleEl) cName = titleEl.textContent;
            }
            
            if (!cName || cName === '{{char}}') cName = 'default';

            // ä½¿ç”¨æ’ä»¶ä¸Šä¼ 
            // ä¼ å…¥å½“å‰è§’è‰²åï¼Œç¡®ä¿æ–‡ä»¶ä¿å­˜åˆ°æ­£ç¡®çš„è§’è‰²æ–‡ä»¶å¤¹ä¸‹
            const result = await window.parent.__fayePhoneSupport_upload(pendingFile, cName);
            
            if (result && result.url) {
                if (pendingFile.type.startsWith('image/')) {
                    // NEW: ä½¿ç”¨ Base64 è€Œä¸æ˜¯è·¯å¾„æ¥ä¼ é€’ç»™ AI
                    // æ ¹æ® TavernHelper æ¥å£æ–‡æ¡£ï¼Œimage å‚æ•°æ”¯æŒ Base64 å­—ç¬¦ä¸²ï¼Œè¿™æ¯”ç›¸å¯¹è·¯å¾„æ›´å¯é 
                    const base64Data = await toBase64(pendingFile);
                    lastUploadedImageForAI = base64Data;

                    // ä½¿ç”¨ Web URL æ˜¾ç¤ºå›¾ç‰‡
                    await sendPhoto(result.url);
                } else if (pendingFile.type.startsWith('audio/')) {
                    await sendRealAudio(result.url);
                } else if (pendingFile.type.startsWith('video/')) {
                    await sendVideo(result.url);
                }
            }
        } catch (err) {
            console.error("Plugin upload failed:", err);
            // å¤±è´¥ä¸å†å›é€€åˆ° Base64ï¼Œè€Œæ˜¯æç¤ºé”™è¯¯ï¼Œé¿å…ä¹±ç 
            alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥: " + (err.message || "æœªçŸ¥é”™è¯¯"));
        }
    } else {
        // æ— æ’ä»¶ - ç¦æ­¢ä¸Šä¼ 
        alert('æœªæ£€æµ‹åˆ°é€‚é…å™¨æ’ä»¶ï¼Œæ— æ³•å‘é€æ–‡ä»¶ã€‚è¯·å®‰è£… FayephoneSupport æ’ä»¶ã€‚');
    }
    // å‘é€å®Œæ–‡ä»¶æ¸…ç†é¢„è§ˆ
    window.clearPreview();
}

// 2. å¤„ç†æ–‡å­—æ¶ˆæ¯
if (text) {
    const t = getTime(); 
    const u = window.userName || '{{user}}'; 
    // å¦‚æœè¢«æ‹‰é»‘ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­æ·»åŠ æ ‡è®° (ç”¨äºæŒä¹…åŒ–)
    let header = `[${u}|${t}]`;
    if (appSettings.blockUser) {
        header = `[${u}|${t}|!]`; // ! è¡¨ç¤ºè¢«æ‹‰é»‘/å‘é€å¤±è´¥
    }
    renderMessageToUI({ header: header, body: text, isUser: true });
    messageInput.value = ''; 
    adjustTextareaHeight(); 
    await rebuildAndSaveHistory();
} 

// 3. è§¦å‘å›å¤é€»è¾‘
// ä¿®æ”¹é€»è¾‘ï¼šåªæœ‰å½“æ—¢æ²¡æœ‰å‘é€æ–‡ä»¶ï¼Œä¹Ÿæ²¡æœ‰è¾“å…¥æ–‡å­—æ—¶ï¼ˆå³çº¯ç²¹çš„ç©ºè¾“å…¥è§¦å‘ï¼‰ï¼Œæ‰è°ƒç”¨ generate è§¦å‘ AI å›å¤ã€‚
// å‘é€æ–‡ä»¶æœ¬èº«è¢«è§†ä¸ºâ€œæœ‰æ•ˆè¾“å…¥â€ï¼Œä¸åº”è¢«å½“ä½œâ€œç©ºæ¶ˆæ¯â€æ¥è§¦å‘é»˜è®¤çš„AIç»­å†™è¡Œä¸ºã€‚
if (typeof generate !== 'undefined' && !text && !fileSent) {
    // ç¨ä½œå»¶è¿Ÿï¼Œç¡®ä¿DOMå’ŒHistoryæ›´æ–°å®Œæ¯•
    setTimeout(() => {
        showTypingIndicator(); 
        triggerGenerate();
    }, 100);
}
renderMessageList();
}

function getTime() {
if (appSettings.timeOffset) {
    const now = new Date();
    const target = new Date(now.getTime() + appSettings.timeOffset);
    return `${target.getHours().toString().padStart(2,'0')}:${target.getMinutes().toString().padStart(2,'0')}`;
}
if (appSettings.customTime && /^\d{1,2}:\d{2}$/.test(appSettings.customTime)) return appSettings.customTime;
const now = new Date(); return `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}

function triggerLoveEffect() {
    const container = document.getElementById('love-effect-layer');
    if (!container) return;
    
    const hearts = ['â¤ï¸', 'ğŸ’–', 'ğŸ’—', 'ğŸ’“', 'ğŸ’•'];
    const count = 15; // Number of hearts
    
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.className = 'love-heart';
            heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDuration = (3 + Math.random() * 2) + 's';
            container.appendChild(heart);
            
            // Cleanup
            setTimeout(() => heart.remove(), 5000);
        }, i * 200);
    }
}

function renderMessageToUI(msg) {
if(!chatMessages) return;
// è¿‡æ»¤æ‰æš—ç½‘æœç´¢è®°å½•å’Œæ—¥è®°
if (msg.header && (msg.header.includes('ã€æœç´¢è®°å½•') || msg.header.includes('ã€æ—¥è®°') || msg.type === 'search-history')) return;
// é¢å¤–æ£€æŸ¥æ¶ˆæ¯ä½“ï¼Œé˜²æ­¢è§£æå¤±è´¥å¯¼è‡´æ—¥è®°æ˜¾ç¤º
if (msg.body && (msg.body.startsWith('ã€æ—¥è®°') || msg.body.startsWith('ã€æœç´¢è®°å½•') || msg.body.includes('<riji:') || msg.body.includes('<jilu:'))) return;

// NEW: å¤„ç†æ’¤å›æ¶ˆæ¯
if (msg.header && msg.header.includes('|æ’¤å›|')) {
    const row = document.createElement('div'); 
    row.className = 'message-row system';
    row.style.justifyContent = 'center';
    row.style.margin = '10px 0';
    
    const el = document.createElement('div');
    el.className = 'recall-notice';
    el.style.fontSize = '12px';
    el.style.color = '#999';
    el.style.backgroundColor = 'rgba(0,0,0,0.05)';
    el.style.padding = '4px 12px';
    el.style.borderRadius = '10px';
    
    let displayName = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}');
    if (msg.header) {
         const parts = msg.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
         if (parts.length > 0 && parts[0]) displayName = parts[0];
    }
    
    const isVoice = msg.header.includes('è¯­éŸ³');
    const typeText = isVoice ? 'è¯­éŸ³' : 'ä¿¡æ¯';
    
    el.textContent = `${displayName}æ’¤å›äº†ä¸€æ¡${typeText}ï¼š${msg.body}`;
    el.dataset.fullHeader = msg.header;
    el.dataset.rawBody = msg.body;
    
    row.appendChild(el);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return;
}

const row = document.createElement('div'); row.className = `message-row ${msg.isUser ? 'sent' : 'received'}`;

// Check for Love Keywords
if (msg.body && typeof msg.body === 'string') {
    const text = msg.body.toLowerCase();
    // æ‰©å±•è§¦å‘è¯ï¼šåŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ã€æ³•æ–‡ã€å¾·æ–‡ã€è¥¿æ–‡ç­‰å¸¸è§è¡¨è¾¾
    // åªè¦åŒ…å« "çˆ±ä½ " æˆ– "å–œæ¬¢ä½ " å°±ä¼šè§¦å‘ï¼Œå“ªæ€•æ˜¯ "æˆ‘ä¸çˆ±ä½ " ä¹Ÿä¼šè§¦å‘ï¼ˆæŒ‰ç”¨æˆ·è¦æ±‚ä¿ç•™è¿™ç§è¶£å‘³æ€§ï¼‰
    if (text.includes('çˆ±ä½ ') || text.includes('å–œæ¬¢ä½ ') || 
        text.includes('love you') || text.includes('miss you') ||
        text.includes('æ„›ã—ã¦ã‚‹') || text.includes('å¥½ã') || // æ—¥è¯­
        text.includes('ì‚¬ë‘í•´') || // éŸ©è¯­
        text.includes('je t\'aime') || // æ³•è¯­
        text.includes('te amo') || // è¥¿ç­ç‰™è¯­
        text.includes('ich liebe dich') || // å¾·è¯­
        text.includes('è¡¨ç™½')) {
        triggerLoveEffect();
    }
}

const avatar = document.createElement('img'); avatar.className = 'avatar'; avatar.src = msg.isUser ? appSettings.userAvatar : appSettings.charAvatar;

const container = document.createElement('div'); container.className = 'msg-container';
const nameEl = document.createElement('div'); nameEl.className = 'msg-name';
let displayName = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}');
if (msg.header) {
const parts = msg.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
if (parts.length > 0 && parts[0]) displayName = parts[0];
}
nameEl.textContent = displayName;
container.appendChild(nameEl);

const wrapper = document.createElement('div'); wrapper.className = 'msg-wrapper';

let el;
const isLoc = msg.type === 'location' || (msg.header && msg.header.includes('ä½ç½®'));
const isTra = msg.type === 'transfer' || (msg.header && msg.header.includes('è½¬è´¦'));
const isFile = msg.type === 'file' || (msg.header && msg.header.includes('æ–‡ä»¶'));
const isVoice = msg.type === 'voice' || (msg.header && msg.header.includes('è¯­éŸ³'));
const isVideo = msg.type === 'video' || (msg.header && msg.header.includes('è§†é¢‘'));
let isPhoto = msg.type === 'photo' || (msg.header && msg.header.includes('å›¾ç‰‡'));
const isSticker = msg.type === 'sticker' || (msg.header && msg.header.includes('è¡¨æƒ…åŒ…'));

const timeMatch = msg.header ? msg.header.match(/\|(\d{2}:\d{2})/) : null;
const timeStr = timeMatch ? timeMatch[1] : getTime();
const timeEl = document.createElement('div'); timeEl.className = 'msg-time'; timeEl.textContent = timeStr;

let displayBody = msg.body;
let displayThought = msg.thought || '';
if (!displayThought && displayBody) {
const thoughtMatch = displayBody.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
if (thoughtMatch) { displayBody = thoughtMatch[1].trim(); displayThought = thoughtMatch[2].trim(); }
}

// Auto-detect Pollinations AI images or Markdown images OR <img> tag images
if (!isLoc && !isTra && !isFile && !isVoice && !isSticker) {
    if (/^!\[.*?\]\(.*?\)$/.test(displayBody) || 
        /^https?:\/\/image\.pollinations\.ai\/prompt\//.test(displayBody) ||
        /^<img>.*?<\/img>$/.test(displayBody)) {
        isPhoto = true;
        // Ensure header has |å›¾ç‰‡| tag for consistency
        if (msg.header && !msg.header.includes('å›¾ç‰‡')) {
            const parts = msg.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
            if (parts.length >= 2) {
                const t = parts.pop();
                msg.header = `[${parts.join('|')}|å›¾ç‰‡|${t}]`;
            }
        }
    }
}
if (isPhoto) {
    const mdMatch = displayBody.match(/!\[.*?\]\((.*?)\)/);
    const imgTagMatch = displayBody.match(/<img>(.*?)<\/img>/);
    if (mdMatch) displayBody = mdMatch[1];
    else if (imgTagMatch) displayBody = imgTagMatch[1];
}

if (isLoc) {
el = document.createElement('div'); el.className = `location-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="location-info"><div class="location-name">${displayBody}</div></div><div class="location-map"><svg class="location-pin" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path><circle cx="12" cy="9" r="2.5" fill="#fff"/></svg></div>`;
} else if (isTra) {
const parts = displayBody.split('|');
el = document.createElement('div'); el.className = `transfer-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="transfer-top"><div class="transfer-icon-circle"><svg viewBox="0 0 24 24"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><div class="transfer-content"><div class="transfer-amount">${parts[0]||'Â¥ 0.00'}</div><div class="transfer-note">${parts[1]||'è½¬è´¦ç»™æ‚¨'}</div></div></div><div class="transfer-bottom">è½¬è´¦</div>`;
} else if (isFile) {
el = document.createElement('div'); el.className = `file-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="file-info"><div class="file-name">${displayBody}</div><div class="file-size">128 KB</div></div><div class="file-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="#eee"></path><polyline points="14 2 14 8 20 8" fill="#ddd"></polyline><text x="50%" y="18" font-size="6" fill="#888" text-anchor="middle" font-family="Arial">FILE</text></svg></div>`;
} else if (isVoice) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸå®éŸ³é¢‘URL (httpå¼€å¤´æˆ–characterså¼€å¤´)
    if (displayBody.startsWith('http') || displayBody.startsWith('characters/') || displayBody.startsWith('UserUploads/') || displayBody.startsWith('/user/images/')) {
        el = document.createElement('div'); 
        el.className = `real-audio-card ${msg.isUser ? 'sent' : 'received'}`;
        // ä¸ºäº†å®‰å…¨å’Œè·¯å¾„æ­£ç¡®ï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¯èƒ½éœ€è¦è¡¥å…¨ã€‚ä½†åœ¨SillyTavernä¸­ç›¸å¯¹è·¯å¾„é€šå¸¸æ˜¯ç›¸å¯¹äºæ ¹ç›®å½•
        el.innerHTML = `<audio controls src="${displayBody}"></audio>`;
    } else {
        // æ—§çš„æ¨¡æ‹Ÿè¯­éŸ³æ˜¾ç¤ºé€»è¾‘
        const parts = displayBody.split('|'); const dur = parseInt(parts[0]) || 5; const txt = parts.slice(1).join('|');
        // Max width 50% of 330px is approx 198px. Let's cap it at 200px.
        const width = Math.min(150, Math.max(65, 40 + txt.length * 10));
        el = document.createElement('div'); el.className = `voice-card ${msg.isUser ? 'sent' : 'received'}`; el.style.width = width + 'px';
        let waves = ''; 
        const barCount = Math.floor((width - 40) / 5);
        for(let i=0;i<barCount;i++) waves += `<div class="wave" style="height:${4 + Math.random()*12}px"></div>`;
        el.innerHTML = `<div class="voice-bar"><div class="voice-duration">${dur}"</div><div class="voice-waves">${waves}</div></div><div class="voice-text ${txt.length > 15 ? 'multiline' : ''}">${txt}</div>`;
        el.onclick = (e) => { if(!activeDeleteBtn) el.classList.toggle('show-text'); };
        if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; }
        else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
    }
} else if (isSticker) {
el = document.createElement('div'); el.className = `sticker-bubble ${msg.isUser ? 'sent' : 'received'}`;
let src = displayBody;
const fileMatch = displayBody.match(/([a-zA-Z0-9_-]+\.[a-zA-Z0-9]+)$/);
if (fileMatch && !displayBody.startsWith('http')) { src = 'https://files.catbox.moe/' + fileMatch[1]; }
el.innerHTML = `<img src="${src}">`;
el.dataset.stickerBody = displayBody;
} else if (isVideo) {
el = document.createElement('div'); el.className = `photo-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<video src="${displayBody}" controls style="width:100%;border-radius:12px;"></video>`;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; }
else { el.style.backgroundColor = appSettings.charBubble; }
} else if (isPhoto) {
el = document.createElement('div'); el.className = `photo-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<img src="${displayBody}">`;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; }
else { el.style.backgroundColor = appSettings.charBubble; }
} else {
el = document.createElement('div'); el.className = `bubble ${msg.isUser ? 'bubble-sent' : 'bubble-received'}`; el.textContent = displayBody;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; }
else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
}

if (msg.header) {
    if (msg.header.startsWith('[') || msg.header.startsWith('ã€')) {
         el.dataset.fullHeader = msg.header;
    } else {
         const isPic = isPhoto || (msg.header && msg.header.includes('å›¾ç‰‡'));
         // ç»Ÿä¸€ä½¿ç”¨ [ ]
         el.dataset.fullHeader = `[${msg.header}]`;
    }
} else { 
    const n = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}'); 
    const t = getTime(); 
    const isPic = isPhoto;
    el.dataset.fullHeader = isPic ? `[${n}|å›¾ç‰‡|${t}]` : `[${n}|${t}]`; 
}

// æ£€æŸ¥æ˜¯å¦è¢«æ‹‰é»‘
// 1. å¦‚æœæ˜¯ç”¨æˆ·å‘çš„æ¶ˆæ¯ï¼Œä¸”å½“å‰å¤„äº Charæ‹‰é»‘User çŠ¶æ€ (appSettings.blockUser)ï¼Œæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·
// 2. å¦‚æœæ˜¯Charå‘çš„æ¶ˆæ¯ï¼Œä¸”å½“å‰å¤„äº Useræ‹‰é»‘Char çŠ¶æ€ (appSettings.blockChar)ï¼Œæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·
let isBlocked = false;
if (msg.isUser && appSettings.blockUser) isBlocked = true;
if (!msg.isUser && appSettings.blockChar) isBlocked = true;

// æ£€æŸ¥æ¶ˆæ¯å¤´ä¸­æ˜¯å¦å·²æœ‰æ ‡è®° (æŒä¹…åŒ–)
if (msg.header && msg.header.includes('!')) isBlocked = true;

// åˆ›å»ºå…ƒæ•°æ®å®¹å™¨ï¼ˆåŒ…å«æ—¶é—´å’ŒçŠ¶æ€å›¾æ ‡ï¼‰
const metaContainer = document.createElement('div');
metaContainer.className = 'msg-meta';

if (isBlocked) {
    const blockIcon = document.createElement('span');
    blockIcon.className = 'msg-status-blocked';
    blockIcon.textContent = '!';
    blockIcon.title = 'æ¶ˆæ¯è¢«æ‹¦æˆª/å‘é€å¤±è´¥';
    metaContainer.appendChild(blockIcon);
}
metaContainer.appendChild(timeEl);

addLongPressHandler(el);
wrapper.appendChild(el); wrapper.appendChild(metaContainer); container.appendChild(wrapper);

if (displayThought) {
const thoughtEl = document.createElement('div'); thoughtEl.className = 'msg-thought';
thoughtEl.textContent = displayThought; container.appendChild(thoughtEl);
}

row.appendChild(avatar); row.appendChild(container); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function rebuildAndSaveHistory() {
try { if (typeof getCurrentMessageId === 'undefined') return; const cn = window.charName || '{{char}}'; const rows = Array.from(chatMessages.children); let nc = '';
for (const row of rows) {
if (row.id === 'typing-bubble' || row.classList.contains('delete-btn')) continue;
const el = row.querySelector('.bubble, .location-card, .transfer-card, .file-card, .voice-card, .real-audio-card, .photo-card, .sticker-bubble, .recall-notice'); if (!el) continue;
let t = "", h = el.dataset.fullHeader;
const thoughtEl = row.querySelector('.msg-thought');
const thoughtSuffix = thoughtEl ? `*${thoughtEl.textContent}*` : '';
if (el.classList.contains('bubble')) t = el.textContent;
else if (el.classList.contains('recall-notice')) t = el.dataset.rawBody;
else if (el.classList.contains('location-card')) t = el.querySelector('.location-name').textContent;
else if (el.classList.contains('transfer-card')) t = `${el.querySelector('.transfer-amount').textContent}|${el.querySelector('.transfer-note').textContent}`;
else if (el.classList.contains('file-card')) t = el.querySelector('.file-name').textContent;
else if (el.classList.contains('voice-card')) t = `${el.querySelector('.voice-duration').textContent.replace('"','')}|${el.querySelector('.voice-text').textContent}`;
else if (el.classList.contains('real-audio-card')) t = el.querySelector('audio').getAttribute('src');
else if (el.classList.contains('sticker-bubble')) { t = el.dataset.stickerBody || el.querySelector('img').src; }
else if (el.classList.contains('photo-card')) {
    const img = el.querySelector('img');
    const vid = el.querySelector('video');
    if (img) {
        // ä¿®æ”¹ï¼šç›´æ¥ä¿¡ä»»æ’ä»¶è¿”å›çš„ /user/images/ è·¯å¾„
        // ä»…è¿›è¡ŒåŸºæœ¬çš„ URL ç¼–ç ä»¥é˜²æ­¢å†å²è®°å½•è§£æé”™è¯¯ï¼ˆç‰¹åˆ«æ˜¯é’ˆå¯¹æ‹¬å·å’Œç©ºæ ¼ï¼‰
        let src = img.getAttribute('src');
        try { src = decodeURI(src); } catch(e) {}
        
        let promptPath = src;
        
        // å¦‚æœåŒ…å«æœ¬åœ° UserUploadsï¼ˆä¾‹å¦‚ä»æ—§å†å²è®°å½•åŠ è½½æˆ–æ‹–æ‹½ä¸Šä¼ ï¼‰ï¼Œå°è¯•ä¿®å¤ä¸º Web è·¯å¾„
        // ä½†æŒ‰æŒ‡ä»¤ï¼Œæˆ‘ä»¬ä¸»è¦ä¿è¯æ’ä»¶ä¸Šä¼ çš„æ–°å›¾ç‰‡è·¯å¾„æ­£ç¡®
        if (promptPath.includes('UserUploads')) {
             const parts = promptPath.split('UserUploads');
             let suffix = parts[1];
             // ç¡®ä¿ Web è·¯å¾„ä»¥ /user/images/ å¼€å¤´
             promptPath = '/user/images' + (suffix.startsWith('/') ? '' : '/') + suffix;
        }

        // è§„èŒƒåŒ–æ–œæ 
        promptPath = promptPath.replace(/\\/g, '/');

        // ä»…å¯¹ç©ºæ ¼å’Œæ‹¬å·è¿›è¡Œç¼–ç ï¼Œä¿æŒä¸­æ–‡å­—ç¬¦å¯è¯»ï¼Œé¿å…ä¹±ç 
        const encodedPath = promptPath.replace(/ /g, '%20').replace(/\(/g, '%28').replace(/\)/g, '%29');
        
        t = `<img>${encodedPath}</img>`;
        
        if (h) {
            h = h.replace(/^ã€/, '[').replace(/ã€‘$/, ']');
            if (!h.includes('|å›¾ç‰‡|')) {
                 const content = h.replace(/^\[|\]$/g, '');
                 const parts = content.split('|');
                 if (parts.length >= 2) {
                     const name = parts.pop(); // The last part is time
                     // Reconstruct properly
                     h = `[${content}|å›¾ç‰‡]`; // Simplification to avoid complex parsing
                     // Actually let's just keep original header if complex
                }
            }
        }
    }
    else if (vid) t = vid.getAttribute('src');
}
if (h && t) nc += `${h}${t}${thoughtSuffix}\n`;
}
const tn = 'chat', sn = String(cn).replace('{{char}}', window.charName || '{{char}}');
const fh = `<fphone>\n<${tn}:${sn}>\n${nc.trim()}\n</${tn}>\n</fphone>`;
await setChatMessages([{ message_id: getCurrentMessageId(), message: fh }], { refresh: 'none' });
} catch (e) { console.error(e); }
}

if (typeof eventOn !== 'undefined') {
const removeTyping = () => { const tb = document.getElementById('typing-bubble'); if (tb) tb.remove(); };
eventOn(iframe_events.GENERATION_ENDED, (resp) => {
removeTyping();
let rt = typeof resp === 'string' ? resp : (resp.text || '');

// NEW: å¤„ç†æš—ç½‘æœç´¢ç»“æœ
if (isWaitingForDarkSearch) {
    isWaitingForDarkSearch = false;
    renderDarkSearchResults(rt);
    // å°è¯•ä»èŠå¤©å†å²ä¸­åˆ é™¤è¯¥æ¡æ¶ˆæ¯
    if (window.parent && window.parent.__fayePhoneSupport_deleteLastMessage) {
        window.parent.__fayePhoneSupport_deleteLastMessage(rt);
    }
    return;
}

// NEW: Handle Diary Generation
if (isWaitingForDiary) {
    isWaitingForDiary = false;
    renderDiaryEntries(rt);
    // å°è¯•ä»èŠå¤©å†å²ä¸­åˆ é™¤è¯¥æ¡æ¶ˆæ¯
    if (window.parent && window.parent.__fayePhoneSupport_deleteLastMessage) {
        window.parent.__fayePhoneSupport_deleteLastMessage(rt);
    }
    return;
}

// æ£€æŸ¥æ˜¯å¦åŒ…å«æ‹‰é»‘æŒ‡ä»¤
if (rt.includes('[æ‹‰é»‘ç”¨æˆ·]')) {
    appSettings.blockUser = true;
    saveSettingsToStorage();
}
if (rt.includes('[è§£é™¤æ‹‰é»‘]')) {
    appSettings.blockUser = false;
    saveSettingsToStorage();
}

// Filter out <riji> blocks just in case they leaked into normal chat
rt = rt.replace(/<riji:.*?>[\s\S]*?<\/riji:.*?>/gi, '').replace(/<jilu:.*?>[\s\S]*?<\/jilu:.*?>/gi, '').trim();

rt = rt.replace(/<fphone>|<\/fphone>|<\/?chat(:.*?)?>/gi, '').trim();
// è¿‡æ»¤æ‰ AI ç”Ÿæˆç»“æœä¸­å¯èƒ½åŒ…å«çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œé˜²æ­¢é‡å¤æ˜¾ç¤º
parseMessages(rt).filter(msg => !msg.isUser).forEach(msg => renderMessageToUI(msg)); 
rebuildAndSaveHistory().then(() => renderMessageList());
});
eventOn(iframe_events.GENERATION_STOPPED, removeTyping);
} else {
// å¦‚æœ eventOn ä¸å¯ç”¨ï¼ˆä¾‹å¦‚åœ¨æŸäº›æ—§ç‰ˆæˆ–ç‰¹æ®Šç¯å¢ƒä¸­ï¼‰ï¼Œä½¿ç”¨ MutationObserver ç›‘å¬ body å˜åŒ–ä½œä¸ºæ›¿ä»£
// è®¸å¤š ST ç‰ˆæœ¬åœ¨ç”Ÿæˆæ—¶ä¼šç»™ body æ·»åŠ  'generating' ç±»æˆ–å…¶ä»–æ ‡è¯†ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥ç›‘å¬æ¶ˆæ¯åˆ—è¡¨çš„å˜åŒ–
const observer = new MutationObserver((mutations) => {
    const tb = document.getElementById('typing-bubble');
    if (tb) {
        // å¦‚æœå‘ç°æ–°æ¶ˆæ¯è¢«æ·»åŠ åˆ°äº†èŠå¤©åŒºåŸŸï¼ˆé typing-bubbleï¼‰ï¼Œåˆ™è®¤ä¸ºç”Ÿæˆå¯èƒ½ç»“æŸäº†
        // è¿™é‡Œéœ€è¦æ›´ç²¾ç¡®çš„é€»è¾‘ï¼Œä½†ä½œä¸ºå…œåº•ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
    }
});
// observer.observe(document.body, { attributes: true, childList: true, subtree: true });
}

function parseMessages(txt) {
const lines = txt.split('\n'), res = [], dr = /^\d{1,2}æœˆ\d{1,2}æ—¥$/, hr = /^(\[([^\]]+)\]|ã€([^ã€‘]+)ã€‘)/, cn = window.charName || '{{char}}';
for (const l of lines) {
const tr = l.trim(); if (!tr) continue; if (dr.test(tr)) { res.push({ type: 'date', body: tr }); continue; }
const m = tr.match(hr);
if (m) {
const hc = m[2] || m[3];
// ä½¿ç”¨åŸå§‹å®Œæ•´ Header (m[0]) åŒ…å«æ‹¬å·ï¼Œä»¥ä¾¿ä¿ç•™å†å²è®°å½•ä¸­çš„ã€ã€‘æ ¼å¼
const fullHeader = m[0]; 
let b = tr.substring(m[0].length).trim();
let thought = '';
const thoughtMatch = b.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
if (thoughtMatch) { b = thoughtMatch[1].trim(); thought = thoughtMatch[2].trim(); }
let type = 'text';
if (hc.includes('ä½ç½®')) type = 'location'; else if (hc.includes('è½¬è´¦')) type = 'transfer'; else if (hc.includes('æ–‡ä»¶')) type = 'file'; else if (hc.includes('è¯­éŸ³')) type = 'voice'; else if (hc.includes('å›¾ç‰‡')) type = 'photo';
else if (hc.includes('è¡¨æƒ…åŒ…')) type = 'sticker';
// Determine if message is from user or char based on header content
const isUser = hc.startsWith('User') || hc.includes(window.userName || '{{user}}');
res.push({ header: fullHeader, body: b, type: type, thought: thought, isUser: isUser });
} else res.push({ header: `${cn}|${getTime()}`, body: tr, type: 'text', isUser: false });
}
return res;
}

function loadInitialChat() {
if(!chatMessages) return;
chatMessages.innerHTML = '';
try { if (typeof getCurrentMessageId === 'undefined') return; const h = getChatMessages(getCurrentMessageId()); if (!h?.[0]?.message) return;
const m = h[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i); if (!m) return;
const c = m[1].replace(/<\/?chat(:.*?)?>/gi, '').trim(); parseMessages(c).forEach(msg => renderMessageToUI(msg));
} catch (e) {}
}

function triggerGenerate() {
const cn = window.charName || '{{char}}', t = getTime();
let injects = [];

// 1. åŸºç¡€ç³»ç»ŸæŒ‡ä»¤ï¼šæ¨¡ä»¿æ‰‹æœºçŸ­ä¿¡
const p = `[ç³»ç»ŸæŒ‡ä»¤] å½“å‰æ—¶é—´${t}ã€‚æˆ‘ä»¬æ­£åœ¨è¿›è¡Œçº¿ä¸ŠèŠå¤©ã€‚
è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1. è¯­å¢ƒï¼šå®Œå…¨æ¨¡ä»¿æ‰‹æœºèŠå¤©è½¯ä»¶çš„é£æ ¼ï¼Œä½¿ç”¨çŸ­å¥ã€å£è¯­ã€é¢œæ–‡å­—ã€‚ä¸å…è®¸ä»»ä½•åŠ¨ä½œæå†™å’Œå°è¯´å™è¿°æ–‡æœ¬ã€‚
2. æ ¼å¼ï¼šè¯·å›å¤ 2-5 æ¡ç®€çŸ­æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿè¿ç»­å‘é€ã€‚
3. è§’è‰²ï¼šä½ åªèƒ½æ‰®æ¼” ${cn} å›å¤æ¶ˆæ¯ï¼Œç¦æ­¢æ‰®æ¼”ç”¨æˆ·è¯´è¯ã€‚`;
    injects.push({ role: 'system', content: p, position: 'at_depth', depth: 0 });

    // 2. é£æ ¼å¼ºåŒ–æŒ‡ä»¤
    const p2 = `[æ ·å¼å¼ºåˆ¶]
1. æ ¼å¼ï¼šä»…è¾“å‡ºçº¯æ–‡æœ¬æ¶ˆæ¯ã€‚ç¦æ­¢ä½¿ç”¨ Markdownã€ä»£ç å—æˆ– XML æ ‡ç­¾ã€‚
2. è¯­æ°”ï¼šä¼‘é—²ã€å¯¹è¯å¼ã€çŸ­ä¿¡é£æ ¼ã€‚é€‚å½“ä½¿ç”¨ä¿šè¯­/è¡¨æƒ…ç¬¦å·ã€‚
3. æ‹‰é»‘æŒ‡ä»¤ï¼šå¦‚æœä½ æƒ³æ‹‰é»‘ç”¨æˆ·ï¼Œè¯·åœ¨å›å¤æœ«å°¾åŠ ä¸Š [æ‹‰é»‘ç”¨æˆ·]ã€‚å¦‚æœä½ æƒ³è§£é™¤æ‹‰é»‘ï¼Œè¯·åŠ ä¸Š [è§£é™¤æ‹‰é»‘]ã€‚`;
    injects.push({ role: 'system', content: p2, position: 'at_depth', depth: 1 });

    // 3. æ‹‰é»‘çŠ¶æ€æ³¨å…¥
    if (appSettings.blockChar) {
        const blockPrompt = `[ç³»ç»Ÿé€šçŸ¥] ç”¨æˆ·å·²å°†ä½ æ‹‰é»‘ã€‚ä½ çš„æ¶ˆæ¯æ— æ³•æ­£å¸¸ä¼ è¾¾ï¼ˆæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·ï¼‰ã€‚è¯·è¡¨ç°å‡ºè¢«æ‹‰é»‘çš„ååº”ï¼ˆå¦‚ç„¦æ€¥ã€è½°ç‚¸æ¶ˆæ¯ã€ç–‘æƒ‘ç­‰ï¼‰ã€‚`;
        injects.push({ role: 'system', content: blockPrompt, position: 'at_depth', depth: 0 });
    }
    if (appSettings.blockUser) {
        const blockPrompt = `[ç³»ç»Ÿé€šçŸ¥] ä½ å·²å°†ç”¨æˆ·æ‹‰é»‘ã€‚ä½ æ— æ³•çœ‹åˆ°ç”¨æˆ·çš„æ¶ˆæ¯å†…å®¹ï¼ˆæ˜¾ç¤ºä¸ºè¢«æ‹¦æˆªï¼‰ã€‚è¯·æ— è§†ç”¨æˆ·çš„å‘è¨€ï¼Œæˆ–è€…è‡ªè¯´è‡ªè¯ã€‚`;
        injects.push({ role: 'system', content: blockPrompt, position: 'at_depth', depth: 0 });
    }

    const genParams = { 
        injects: injects, 
        should_stream: false, 
        max_chat_history: 300 
    };

// 2. å›¾åƒè¯†åˆ«/å¤šæ¨¡æ€é€»è¾‘
// å¦‚æœä¹‹å‰ä¸Šä¼ äº†å›¾ç‰‡ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ¶ˆè´¹æ‰ï¼Œåˆ™å°†å…¶åŠ å…¥åˆ°æœ¬æ¬¡ç”Ÿæˆè¯·æ±‚ä¸­
if (lastUploadedImageForAI) {
    // é…’é¦†åŠ©æ‰‹ generate å‡½æ•°çš„ image å‚æ•°æ”¯æŒ File å¯¹è±¡
    genParams.image = lastUploadedImageForAI;
    
    // å¢åŠ é’ˆå¯¹å›¾ç‰‡çš„å¼•å¯¼æŒ‡ä»¤
    const imagePrompt = `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ã€‚è¯·è°ƒç”¨ä½ çš„è§†è§‰èƒ½åŠ›åˆ†æè¿™å¼ å›¾ç‰‡ã€‚
    é‡è¦ï¼šä¸å¯ä»¥ç›´ç™½æè¿°å›¾ç‰‡å†…å®¹ï¼ˆå¦‚"è¿™æ˜¯ä¸€å¼ ..."ï¼‰ã€‚è¦å¯¹æ ¹æ®äººç‰©è®¾å®šå¯¹å›¾ç‰‡åšå‡ºè‡ªç„¶ååº”ï¼ˆå¦‚è¯„ä»·ã€è¡¨è¾¾æ„Ÿå—ã€åæ§½ç­‰ï¼‰ï¼Œå°±åƒåœ¨èŠå¤©è½¯ä»¶ä¸­æ”¶åˆ°è¿™å¼ å›¾ä¸€æ ·ã€‚`;
    injects.push({ role: 'system', content: imagePrompt, position: 'at_depth', depth: 0 });
    
    // æ¶ˆè´¹æ‰è¯¥å˜é‡ï¼Œé˜²æ­¢é‡å¤å‘é€
    lastUploadedImageForAI = null;
}

generate(genParams);
}

// ç›‘å¬ AI å›å¤ï¼Œè§£ææ‹‰é»‘æŒ‡ä»¤
if (typeof eventOn !== 'undefined') {
    eventOn(iframe_events.GENERATION_ENDED, (resp) => {
        let rt = typeof resp === 'string' ? resp : (resp.text || '');
        
        // NEW: å¤„ç†æš—ç½‘æœç´¢ç»“æœ
        if (isWaitingForDarkSearch) {
            isWaitingForDarkSearch = false;
            renderDarkSearchResults(rt);
            // å°è¯•ä»èŠå¤©å†å²ä¸­åˆ é™¤è¯¥æ¡æ¶ˆæ¯
            if (window.parent && window.parent.__fayePhoneSupport_deleteLastMessage) {
                // ä¼ å…¥å®Œæ•´å†…å®¹è¿›è¡ŒåŒ¹é…éªŒè¯ï¼Œé˜²æ­¢è¯¯åˆ 
                window.parent.__fayePhoneSupport_deleteLastMessage(rt);
            }
            return;
        }

        // NEW: Handle Diary Generation
        if (isWaitingForDiary) {
            isWaitingForDiary = false;
            renderDiaryEntries(rt);
            // å°è¯•ä»èŠå¤©å†å²ä¸­åˆ é™¤è¯¥æ¡æ¶ˆæ¯
            if (window.parent && window.parent.__fayePhoneSupport_deleteLastMessage) {
                // ä¼ å…¥å®Œæ•´å†…å®¹è¿›è¡ŒåŒ¹é…éªŒè¯ï¼Œé˜²æ­¢è¯¯åˆ 
                window.parent.__fayePhoneSupport_deleteLastMessage(rt);
            }
            return;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ‹‰é»‘æŒ‡ä»¤
        if (rt.includes('[æ‹‰é»‘ç”¨æˆ·]')) {
            appSettings.blockUser = true;
            saveSettingsToStorage();
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ª Toast æç¤ºæˆ–è€…åˆ·æ–°è®¾ç½®ç•Œé¢
        }
        if (rt.includes('[è§£é™¤æ‹‰é»‘]')) {
            appSettings.blockUser = false;
            saveSettingsToStorage();
        }
    });
}

function showTypingIndicator() {
const row = document.createElement('div'); row.id = 'typing-bubble'; row.className = 'message-row received';
const av = document.createElement('img'); av.className = 'avatar'; av.src = appSettings.charAvatar;
const el = document.createElement('div'); el.className = 'bubble bubble-received';
el.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>'; el.style.backgroundColor = appSettings.charBubble;
row.appendChild(av); row.appendChild(el); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
// ç‚¹å‡»æ°”æ³¡ç§»é™¤åŠ¨ç”»
row.onclick = () => row.remove();
}
function adjustTextareaHeight() { messageInput.style.height = 'auto'; messageInput.style.height = messageInput.scrollHeight + 'px'; }
function clearDeleteButton() { if (activeDeleteBtn) { activeDeleteBtn.remove(); activeDeleteBtn = null; } document.querySelectorAll('.delete-mode').forEach(el => el.classList.remove('delete-mode')); }
function executeDelete(el) { const r = el.closest('.message-row'); r.style.transform = 'scale(0)'; setTimeout(async () => { r.remove(); clearDeleteButton(); await rebuildAndSaveHistory(); }, 200); }
function addLongPressHandler(el) {
let timer; const start = (e) => { if(e.target.closest('.delete-btn')) return; el.classList.add('pressing'); timer = setTimeout(() => { el.classList.remove('pressing'); showDeleteButton(el); }, 500); };
const cancel = () => { clearTimeout(timer); el.classList.remove('pressing'); };
el.addEventListener('mousedown', start);
el.addEventListener('touchstart', start, {passive:true});
['mouseup','mouseleave','touchend','touchmove'].forEach(ev => el.addEventListener(ev, cancel));
}
function showDeleteButton(el) {
clearDeleteButton(); el.classList.add('delete-mode'); const btn = document.createElement('div'); btn.className = 'delete-btn';
btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
btn.onclick = (e) => { e.stopPropagation(); executeDelete(el); }; el.appendChild(btn); activeDeleteBtn = btn;
}
document.onclick = (e) => {
    if(activeDeleteBtn && !e.target.closest('.location-card, .transfer-card, .file-card, .bubble, .voice-card, .real-audio-card, .photo-card, .sticker-bubble')) clearDeleteButton();
    
    if (!e.target.closest('.sticker-item')) {
        document.querySelectorAll('.sticker-item .delete-btn').forEach(b => b.remove());
        document.querySelectorAll('.sticker-item.delete-mode').forEach(i => i.classList.remove('delete-mode'));
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
    if (actionMenu && actionMenu.classList.contains('open') && !e.target.closest('#action-menu') && !e.target.closest('#plus-button')) {
        closeMenus();
    }
    if (emojiMenu && emojiMenu.classList.contains('open') && !e.target.closest('#emoji-menu') && !e.target.closest('#emoji-button')) {
        closeMenus();
    }
};

function triggerSettingsUpload(type) {
    currentSettingsUploadType = type;
    const input = document.getElementById('settings-file-input');
    if (input) input.click();
}

function init() {
// Initialize references
phoneContainer = document.getElementById('phone-container');
homeScreen = document.getElementById('home-screen');
chatScreen = document.getElementById('chat-screen');
settingsScreen = document.getElementById('settings-screen');
messageListScreen = document.getElementById('message-list-screen');
messageListBody = document.getElementById('message-list-body');
chatMessages = document.getElementById('chat-messages');
messageInput = document.getElementById('message-input');
sendButton = document.getElementById('send-button');
plusButton = document.getElementById('plus-button');
emojiButton = document.getElementById('emoji-button');
actionMenu = document.getElementById('action-menu');
emojiMenu = document.getElementById('emoji-menu');
modal = document.getElementById('input-modal');
modalTitle = document.getElementById('modal-title');
modalInputsContainer = document.getElementById('modal-inputs-container');
modalConfirmBtn = document.getElementById('modal-confirm-btn');
chatSettingsModal = document.getElementById('chat-settings-modal');
headerTitle = document.getElementById('header-title');
clockEl = document.getElementById('clock');
homeClockEl = document.getElementById('home-clock');
statusBar = document.getElementById('status-bar');
photoInput = document.getElementById('photo-upload-input');
// New References
audioInput = document.getElementById('audio-upload-input');
videoInput = document.getElementById('video-upload-input');
mediaPreviewBar = document.getElementById('media-preview-bar');
previewImage = document.getElementById('preview-image');
previewFileIcon = document.getElementById('preview-file-icon');
adapterStatus = document.getElementById('adapter-status');
darkSearchScreen = document.getElementById('dark-search-screen');
darkSearchInput = document.getElementById('dark-search-input');
diaryScreen = document.getElementById('diary-screen');

// Bind Events
// å›¾ç‰‡ä¸Šä¼ 
if(photoInput) photoInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
        e.target.value = ''; // Reset for re-selection
        closeMenus(); // Close action menu
    }
});

// éŸ³é¢‘ä¸Šä¼ 
if(audioInput) audioInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
        e.target.value = '';
        closeMenus();
    }
});

// è§†é¢‘ä¸Šä¼ 
if(videoInput) videoInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
        e.target.value = '';
        closeMenus();
    }
});

// è®¾ç½®é¡µé¢æ–‡ä»¶ä¸Šä¼ 
const settingsFileInput = document.getElementById('settings-file-input');
if (settingsFileInput) {
    settingsFileInput.addEventListener('change', async (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            try {
                let url = '';
                // å°è¯•ä½¿ç”¨çˆ¶çº§ä¸Šä¼ æ¥å£
                if (window.parent && window.parent.__fayePhoneSupport_upload) {
                    // è·å–è§’è‰²å (é€»è¾‘åŒ sendMessage)
                    let cName = 'default';
                    if (window.parent && window.parent.SillyTavern) {
                        try {
                            const ctx = window.parent.SillyTavern.getContext();
                            if (ctx) {
                                let chars = ctx.characters;
                                if (chars && typeof chars.then === 'function') chars = await chars;
                                if (chars && ctx.characterId && chars[ctx.characterId]) {
                                    cName = chars[ctx.characterId].name;
                                }
                            }
                        } catch(e) { console.log('Parent context unavailable in settings upload'); }
                    }
                    if (!cName || cName === 'default' || cName === '{{char}}') {
                        const titleEl = document.getElementById('header-title');
                        if (titleEl) cName = titleEl.textContent;
                    }
                    if (!cName || cName === '{{char}}') cName = 'default';

                    // ä½¿ç”¨æ’ä»¶ä¸Šä¼ ï¼Œä¼ å…¥è§’è‰²åä»¥ä¿æŒè·¯å¾„ä¸€è‡´
                    const result = await window.parent.__fayePhoneSupport_upload(file, cName);
                    
                    if (result && typeof result === 'object' && result.url) {
                        url = result.url;
                    } else if (typeof result === 'string') {
                        url = result;
                    }
                } else {
                    // é™çº§å¤„ç†ï¼šè½¬ä¸º Base64
                    url = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                if (url) {
                    if (currentSettingsUploadType === 'char-avatar') {
                        // ä»…æ›´æ–°é¢„è§ˆå’Œä¸´æ—¶è®¾ç½®å¯¹è±¡ï¼Œä¸ç«‹å³ä¿å­˜åˆ° localStorage
                        appSettings.charAvatar = url;
                        const preview = document.getElementById('preview-char-avatar');
                        if(preview) preview.src = url;
                    } else if (currentSettingsUploadType === 'user-avatar') {
                        appSettings.userAvatar = url;
                        const preview = document.getElementById('preview-user-avatar');
                        if(preview) preview.src = url;
                    } else if (currentSettingsUploadType === 'chat-bg') {
                        appSettings.chatBg = url;
                        const preview = document.getElementById('preview-chat-bg');
                        if(preview) preview.src = url;
                    } else if (currentSettingsUploadType === 'home-bg') {
                        appSettings.homeBg = url;
                        const preview = document.getElementById('preview-home-bg');
                        if(preview) preview.src = url;
                    }
                }
            } catch (err) {
                console.error("Upload failed", err);
                alert("ä¸Šä¼ å¤±è´¥: " + err.message);
            }
            e.target.value = ''; // Reset
        }
    });
}

if(plusButton) plusButton.addEventListener('click', () => {
if (actionMenu.classList.contains('open')) closeMenus();
else { closeMenus(); actionMenu.classList.add('open'); plusButton.classList.add('active'); clearDeleteButton(); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
});
if(emojiButton) emojiButton.addEventListener('click', () => {
if (emojiMenu.classList.contains('open')) closeMenus();
else { closeMenus(); emojiMenu.classList.add('open'); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
});
if(messageInput) {
messageInput.addEventListener('focus', closeMenus);
messageInput.oninput = adjustTextareaHeight;
messageInput.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
}
if(sendButton) sendButton.onclick = sendMessage;
if(modalConfirmBtn) modalConfirmBtn.onclick = (e) => {
if(e) e.preventDefault();
if (currentConfirmAction) {
const inputs = modalInputsContainer.querySelectorAll('input');
const values = Array.from(inputs).map(i => i.value.trim());
if (values[0]) {
currentConfirmAction(values);
// Only remove the 'show' class from the input modal, explicitly do not call closeModal
if(modal) modal.classList.remove('show');
currentConfirmAction = null; // Clean up immediately after execution
}
}
};

loadSettings();
const savedStickers = localStorage.getItem('st-phone-stickers');
myStickerList = savedStickers ? JSON.parse(savedStickers) : defaultStickerList;
const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OS00IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
if(!appSettings.charAvatar) appSettings.charAvatar = defaultAvatar;
if(!appSettings.userAvatar) appSettings.userAvatar = defaultAvatar;
applySettings();
if(headerTitle) headerTitle.textContent = window.charName || '{{char}}';
updateClock();
initStickers();
setInterval(updateClock, 1000);
// ç«‹å³æ£€æŸ¥ä¸€æ¬¡è§’è‰²å˜åŒ–ï¼Œä»¥ä¾¿å°½å¿«åŠ è½½ç‰¹å®šè§’è‰²çš„è®¾ç½®
checkCharacterChange();
setInterval(checkCharacterChange, 1000);
try { loadInitialChat(); setTimeout(loadInitialChat, 500); } catch(e){}
}

// Attach globally
window.openChat = openChat;
window.openMessageList = openMessageList;
window.goBack = goBack;
window.openSettings = openSettings;
window.closeSettings = closeSettings;
window.openChatSettings = openChatSettings;
window.saveHomeSettings = saveHomeSettings;
window.saveChatSettings = saveChatSettings;
window.handleAction = handleAction;
window.closeModal = closeModal;
window.handleUploadUrl = handleUploadUrl;
window.triggerSettingsUpload = triggerSettingsUpload;
window.openDarkSearch = openDarkSearch;
window.closeDarkSearch = closeDarkSearch;
window.searchDarkWeb = searchDarkWeb;
window.openDiary = openDiary;
window.closeDiary = closeDiary;
window.generateDiary = generateDiary;

// Initialize on Load
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', init);
} else {
init();
}
})();
</script>
</body>
</html>
